<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Студия Озвучки</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="w-full max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Студия Озвучки</h1>
            <p class="text-gray-500 mt-2">Введите диалог, и я озвучу его разными голосами.</p>
        </header>

        <main>
            <div class="mb-4">
                <label for="script" class="block text-sm font-medium text-gray-700 mb-2">Сценарий для озвучки:</label>
                <textarea id="script" rows="10" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="Пример:
Анна: Привет!
Максим: Привет, Анна! Как дела?">Анна: Приветствие слушателям. Знакомство с темой. «Вы когда-нибудь чувствовали, что ваша вера стала пресной, как еда без соли? Вы делаете всё "правильно", но радости и жизни внутри нет?»
Максим: Объяснение метафоры из Писания. «Сегодня мы будем говорить о пожалуй одном из самых ярких образов, который использовал Иисус — "соль земли". Что это значит и почему соль может потерять свою силу?»
Анна: Анонс структуры выпуска. «Мы поговорим о признаках "пресной" веры, вспомним одну историю и, главное, найдём практические шаги к обновлению».</textarea>
            </div>
            
            <button id="generate-btn" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                Озвучить
            </button>

            <div id="loading" class="hidden text-center my-4 flex flex-col items-center">
                <div class="loader"></div>
                <p class="text-gray-600 mt-3">Генерация аудио... Это может занять несколько секунд.</p>
            </div>

            <div id="error" class="hidden text-center my-4 p-3 bg-red-100 text-red-700 rounded-lg"></div>

            <div id="audio-player-container" class="hidden mt-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-2 text-center">Ваша аудиозапись готова!</h3>
                <audio id="audio-player" controls class="w-full"></audio>
            </div>
        </main>
    </div>

    <script>
        const generateBtn = document.getElementById('generate-btn');
        const scriptTextarea = document.getElementById('script');
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const audioPlayerContainer = document.getElementById('audio-player-container');
        const audioPlayer = document.getElementById('audio-player');

        // --- Вспомогательные функции для работы с аудио ---

        /**
         * Декодирует строку Base64 в ArrayBuffer.
         * @param {string} base64 - Строка в формате Base64.
         * @returns {ArrayBuffer} - Декодированные бинарные данные.
         */
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        /**
         * Конвертирует сырые PCM аудиоданные в WAV Blob.
         * @param {Int16Array} pcmData - Массив 16-битных PCM-сэмплов.
         * @param {number} sampleRate - Частота дискретизации (например, 24000).
         * @returns {Blob} - Аудиоданные в формате WAV.
         */
        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1;
            const bitsPerSample = 16;
            const byteRate = sampleRate * numChannels * bitsPerSample / 8;
            const blockAlign = numChannels * bitsPerSample / 8;
            const dataSize = pcmData.length * 2;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);

            // Заголовок WAV
            // RIFF chunk descriptor
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataSize, true);
            writeString(view, 8, 'WAVE');
            // "fmt " sub-chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); // Audio format (1 = PCM)
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitsPerSample, true);
            // "data" sub-chunk
            writeString(view, 36, 'data');
            view.setUint32(40, dataSize, true);

            // Запись PCM данных
            let offset = 44;
            for (let i = 0; i < pcmData.length; i++, offset += 2) {
                view.setInt16(offset, pcmData[i], true);
            }
            
            return new Blob([view], { type: 'audio/wav' });
        }
        
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }


        // --- Основная логика ---

        generateBtn.addEventListener('click', async () => {
            const script = scriptTextarea.value.trim();
            if (!script) {
                showError('Пожалуйста, введите текст для озвучки.');
                return;
            }

            setLoading(true);
            
            try {
                // Прямой вызов API, без экспоненциальной задержки для простоты примера
                await generateAndPlayAudio(script);
            } catch (error) {
                console.error('Ошибка при генерации аудио:', error);
                showError(`Произошла ошибка: ${error.message}`);
            } finally {
                setLoading(false);
            }
        });

        async function generateAndPlayAudio(script) {
            // Подготовка промпта для мультиспикерной модели
            const fullPrompt = `TTS the following conversation between Анна and Максим:\n${script}`;
            
            const payload = {
                contents: [{
                    parts: [{ text: fullPrompt }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        multiSpeakerVoiceConfig: {
                            speakerVoiceConfigs: [
                                // Голоса подобраны для контраста
                                { speaker: "Анна", voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } }, // Женский, уверенный
                                { speaker: "Максим", voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } } // Мужской, энергичный
                            ]
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            const apiKey = ""; // API-ключ будет предоставлен средой выполнения
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            const part = result?.candidates?.[0]?.content?.parts?.[0];
            const audioData = part?.inlineData?.data;
            const mimeType = part?.inlineData?.mimeType;

            if (audioData && mimeType && mimeType.startsWith("audio/")) {
                const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                if (!sampleRateMatch) {
                    throw new Error("Не удалось определить частоту дискретизации из mimeType.");
                }
                const sampleRate = parseInt(sampleRateMatch[1], 10);
                const pcmData = base64ToArrayBuffer(audioData);
                const pcm16 = new Int16Array(pcmData);
                const wavBlob = pcmToWav(pcm16, sampleRate);
                const audioUrl = URL.createObjectURL(wavBlob);

                audioPlayer.src = audioUrl;
                audioPlayerContainer.classList.remove('hidden');
                audioPlayer.play();
            } else {
                throw new Error("Ответ API не содержит ожидаемых аудиоданных.");
            }
        }

        // --- Управление UI ---

        function setLoading(isLoading) {
            if (isLoading) {
                generateBtn.disabled = true;
                generateBtn.classList.add('opacity-50', 'cursor-not-allowed');
                loadingDiv.classList.remove('hidden');
                errorDiv.classList.add('hidden');
                audioPlayerContainer.classList.add('hidden');
            } else {
                generateBtn.disabled = false;
                generateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                loadingDiv.classList.add('hidden');
            }
        }

        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }
    </script>
</body>
</html>

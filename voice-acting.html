<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Студия Озвучки</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 32px; height: 32px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext {
            visibility: hidden; width: 220px; background-color: #555;
            color: #fff; text-align: center; border-radius: 6px;
            padding: 5px 10px; position: absolute; z-index: 1;
            bottom: 125%; left: 50%; margin-left: -110px;
            opacity: 0; transition: opacity .3s; font-size: 12px; font-weight: 500;
        }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen py-10">
    <div class="w-full max-w-3xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Тестовая Студия Озвучки</h1>
            <p class="text-gray-500 mt-2">Настройте голоса и стиль, чтобы получить идеальную озвучку.</p>
        </header>

        <main>
            <!-- СЦЕНАРИЙ -->
            <div class="mb-4">
                <label for="script" class="block text-sm font-medium text-gray-700 mb-2">Сценарий для озвучки:</label>
                <textarea id="script" rows="10"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                    placeholder="Пример: Анна: Привет! Максим: Привет, Анна! Как дела?">
Игорь: В начале было Слово.
Марина: Что же было до начала?
Игорь: Божя Любовь.
                </textarea>
            </div>

            <!-- РАСШИРЕННЫЕ НАСТРОЙКИ -->
            <div class="mt-6 border-t pt-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Расширенные настройки</h2>

                <!-- ИНСТРУКЦИИ ПО СТИЛЮ (на всю ширину) -->
                <div class="mb-6">
                    <label for="style-instructions" class="block text-sm font-medium text-gray-700 mb-2">
                        Инструкции по стилю
                    </label>
                   <input type="text" id="style-instructions"
       			class="w-full p-2 border border-gray-300 rounded-lg"
       			placeholder="Пример: говори спокойно, с лёгкой грустью, делай паузы после запятых"
       			value="говори тепло, уверенно, с небольшой паузой после запятой">
                </div>

                <!-- ГОЛОСА -->
                <div>
                    <h3 class="text-lg font-medium text-gray-700 mb-3">Настройка голосов</h3>
                    <div id="speaker-list" class="space-y-3"></div>
                    <button id="add-speaker-btn"
                        class="mt-4 bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition text-sm">
                        + Добавить спикера
                    </button>
                </div>
            </div>

            <!-- КНОПКА ОЗВУЧИТЬ -->
            <button id="generate-btn"
                class="mt-8 w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                     stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                </svg>
                Озвучить
            </button>

            <!-- ИНДИКАТОР ЗАГРУЗКИ / ОШИБКА / ПЛЕЕР -->
            <div id="loading" class="hidden text-center my-4 flex flex-col items-center">
                <div class="loader"></div>
                <p class="text-gray-600 mt-3">Генерация аудио... Это может занять несколько секунд.</p>
            </div>
            <div id="error" class="hidden text-center my-4 p-3 bg-red-100 text-red-700 rounded-lg"></div>
            <div id="audio-player-container" class="hidden mt-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-2 text-center">Ваша аудиозапись готова!</h3>
                <audio id="audio-player" controls class="w-full"></audio>
            </div>
        </main>
    </div>

    <script>
        /* ---------- ЭЛЕМЕНТЫ ---------- */
        const generateBtn      = document.getElementById('generate-btn');
        const scriptTextarea   = document.getElementById('script');
        const loadingDiv       = document.getElementById('loading');
        const errorDiv         = document.getElementById('error');
        const audioPlayerContainer = document.getElementById('audio-player-container');
        const audioPlayer      = document.getElementById('audio-player');
        const speakerListDiv   = document.getElementById('speaker-list');
        const addSpeakerBtn    = document.getElementById('add-speaker-btn');

        /* ---------- API-КЛЮЧ (вставьте свой) ---------- */
        const apiKey = "AIzaSyC7ftRUnNdXxHUZxaCrhlhH9h3AGMP2_To"; // <-- ваш ключ
        /* ---------- СПИСОК ГОЛОСОВ ---------- */
        const VOICES = [
            {id:'Zephyr',name:'Zephyr (Яркий)'},{id:'Puck',name:'Puck (Оптимистичный)'},{id:'Charon',name:'Charon (Информативный)'},
            {id:'Kore',name:'Kore (Твёрдый)'},{id:'Fenrir',name:'Fenrir (Возбудимый)'},{id:'Leda',name:'Leda (Молодёжный)'},
            {id:'Orus',name:'Orus (Твёрдый)'},{id:'Aoede',name:'Aoede (Свежий)'},{id:'Callirrhoe',name:'Callirrhoe (Спокойный)'},
            {id:'Autonoe',name:'Autonoe (Яркий)'},{id:'Enceladus',name:'Enceladus (Придыхательный)'},{id:'Iapetus',name:'Iapetus (Чёткий)'},
            {id:'Umbriel',name:'Umbriel (Спокойный)'},{id:'Algieba',name:'Algieba (Мягкий)'},{id:'Despina',name:'Despina (Мягкий)'},
            {id:'Erinome',name:'Erinome (Чёткий)'},{id:'Algenib',name:'Algenib (Хриплый)'},{id:'Rasalgethi',name:'Rasalgethi (Информативный)'},
            {id:'Laomedeia',name:'Laomedeia (Оптимистичный)'},{id:'Achernar',name:'Achernar (Мягкий)'},{id:'Alnilam',name:'Alnilam (Твёрдый)'},
            {id:'Schedar',name:'Schedar (Ровный)'},{id:'Gacrux',name:'Gacrux (Зрелый)'},{id:'Pulcherrima',name:'Pulcherrima (Прямой)'},
            {id:'Achird',name:'Achird (Дружелюбный)'},{id:'Zubenelgenubi',name:'Zubenelgenubi (Непринуждённый)'},{id:'Vindemiatrix',name:'Vindemiatrix (Нежный)'},
            {id:'Sadachbia',name:'Sadachbia (Живой)'},{id:'Sadaltager',name:'Sadaltager (Осведомлённый)'},{id:'Sulafat',name:'Sulafat (Тёплый)'}
        ];

        /* ---------- ДИНАМИЧЕСКИЕ СПИКЕРЫ ---------- */
        function createSpeakerRow(name='', selectedVoice=''){
            const div = document.createElement('div');
            div.className = 'grid grid-cols-1 md:grid-cols-6 gap-2 items-center';
            const voiceOpts = VOICES.map(v=>`<option value="${v.id}" ${v.id===selectedVoice?'selected':''}>${v.name}</option>`).join('');
            div.innerHTML = `
                <input type="text" class="md:col-span-2 w-full p-2 border border-gray-300 rounded-lg speaker-name" placeholder="Имя спикера" value="${name}">
                <select class="md:col-span-3 w-full p-2 border border-gray-300 rounded-lg speaker-voice bg-white">${voiceOpts}</select>
                <button class="md:col-span-1 w-full bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 remove-speaker-btn">Удалить</button>
            `;
            div.querySelector('.remove-speaker-btn').addEventListener('click',()=>div.remove());
            speakerListDiv.appendChild(div);
        }
        addSpeakerBtn.addEventListener('click',()=>createSpeakerRow());
        document.addEventListener('DOMContentLoaded',()=>{
            createSpeakerRow('Марина','Kore');
            createSpeakerRow('Игорь','Puck');
        });

        /* ---------- ГЕНЕРАЦИЯ АУДИО ---------- */
        generateBtn.addEventListener('click', async()=>{
            if(!apiKey){ showError('Вставьте API-ключ в переменную apiKey'); return; }
            const script = scriptTextarea.value.trim();
            if(!script){ showError('Введите текст для озвучки'); return; }
            setLoading(true);
            try{ await generateAndPlayAudio(script); }
            catch(err){ console.error(err); showError(err.message); }
            finally{ setLoading(false); }
        });

        async function generateAndPlayAudio(script){
            const styleInstructions = document.getElementById('style-instructions').value.trim();

            /* собираем спикеров */
            const speakerEls = document.querySelectorAll('#speaker-list > div');
            const speakerVoiceConfigs=[], speakerNames=[];
            speakerEls.forEach(el=>{
                const name = el.querySelector('.speaker-name').value.trim();
                const voice= el.querySelector('.speaker-voice').value;
                if(name&&voice){
                    speakerVoiceConfigs.push({speaker:name, voiceConfig:{prebuiltVoiceConfig:{voiceName:voice}}});
                    speakerNames.push(name);
                }
            });
            if(!speakerVoiceConfigs.length) throw new Error('Добавьте хотя бы одного спикера');

            /* формируем prompt */
	        let fullPrompt = '';
		if (styleInstructions) {
    		fullPrompt += `Say this with the following style: ${styleInstructions}. `;
		}
		fullPrompt += `TTS the following script. Character names before ":" are labels only — do NOT voice them. Begin each line directly with the spoken text after the colon.\n\n${script}`;

            const payload = {
                contents:[{parts:[{text:fullPrompt}]}],
                generationConfig:{
                    responseModalities:["AUDIO"],
                    speechConfig:{ multiSpeakerVoiceConfig:{speakerVoiceConfigs} }
                },
                model:"gemini-2.5-flash-preview-tts"
            };
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
            const res = await fetch(url,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
            if(!res.ok){ const e = await res.json(); throw new Error(e.error?.message||`HTTP ${res.status}`); }

            const result = await res.json();
            const part   = result?.candidates?.[0]?.content?.parts?.[0];
            const audio  = part?.inlineData?.data;
            const mime   = part?.inlineData?.mimeType;
            if(!audio||!mime||!mime.startsWith('audio/')) throw new Error('Нет аудио в ответе');

            const sampleRate = parseInt(mime.match(/rate=(\d+)/)[1],10);
            const pcm16      = new Int16Array(base64ToArrayBuffer(audio));
            const wavBlob    = pcmToWav(pcm16,sampleRate);
            const audioUrl   = URL.createObjectURL(wavBlob);
            audioPlayer.src  = audioUrl;
            audioPlayerContainer.classList.remove('hidden');
            audioPlayer.play();
        }

        /* ---------- УТИЛИТЫ ---------- */
        function base64ToArrayBuffer(base64){
            const b=window.atob(base64), len=b.length, bytes=new Uint8Array(len);
            for(let i=0;i<len;i++) bytes[i]=b.charCodeAt(i);
            return bytes.buffer;
        }
        function pcmToWav(pcmData,sampleRate){
            const numChannels=1, bitsPerSample=16, byteRate=sampleRate*numChannels*bitsPerSample/8;
            const blockAlign=numChannels*bitsPerSample/8, dataSize=pcmData.length*2, buffer=new ArrayBuffer(44+dataSize);
            const view=new DataView(buffer);
            const writeString=(v,o,s)=>{for(let i=0;i<s.length;i++)v.setUint8(o+i,s.charCodeAt(i))};
            writeString(view,0,'RIFF'); view.setUint32(4,36+dataSize,true); writeString(view,8,'WAVE');
            writeString(view,12,'fmt '); view.setUint32(16,16,true); view.setUint16(20,1,true);
            view.setUint16(22,numChannels,true); view.setUint32(24,sampleRate,true); view.setUint32(28,byteRate,true);
            view.setUint16(32,blockAlign,true); view.setUint16(34,bitsPerSample,true); writeString(view,36,'data');
            view.setUint32(40,dataSize,true); let offset=44;
            for(let i=0;i<pcmData.length;i++,offset+=2) view.setInt16(offset,pcmData[i],true);
            return new Blob([view],{type:'audio/wav'});
        }
        function setLoading(v){
            generateBtn.disabled=v;
            generateBtn.classList.toggle('opacity-50',v);
            generateBtn.classList.toggle('cursor-not-allowed',v);
            loadingDiv.classList.toggle('hidden',!v);
            if(v){ errorDiv.classList.add('hidden'); audioPlayerContainer.classList.add('hidden'); }
        }
        function showError(msg){ errorDiv.textContent=msg; errorDiv.classList.remove('hidden'); }
    </script>
</body>
</html>
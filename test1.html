<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Біблійний Асистент</title>
    <script src="https://christian-word.github.io/bible-engine/bible-API.js"></script>
    
    <style>
        :root {
            --primary: #1a73e8;
            --bg: #f8f9fa;
            --card: #ffffff;
            --text: #202124;
            --muted: #5f6368;
            --border: #dadce0;
            --hover: #f1f3f4;
            --success: #34a853;
            --danger: #ea4335;
            --accent: #ffcc00;
        }

        [data-theme="dark"] {
            --bg: #1a1a1a;
            --card: #2d2d2d;
            --text: #ffffff;
            --muted: #aaaaaa;
            --border: #444;
            --hover: #383838;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Боковая панель */
        .sidebar {
            width: 320px;
            background: var(--card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .sidebar.collapsed {
            transform: translateX(-280px);
            width: 40px;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .collapse-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }

        .collapse-btn:hover {
            background: var(--hover);
        }

        /* Строка поиска */
        .search-container {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .search-box {
            position: relative;
            width: 100%;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 40px;
            border: 1px solid var(--border);
            border-radius: 24px;
            font-size: 14px;
            outline: none;
            background: var(--hover);
            transition: all 0.2s;
        }

        .search-input:focus {
            background: white;
            border-color: var(--primary);
            box-shadow: 0 2px 5px 1px rgba(64,60,67,.16);
        }

        .search-placeholder {
            position: absolute;
            left: 40px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--muted);
            font-size: 14px;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .search-input:focus + .search-placeholder,
        .search-input:not(:placeholder-shown) + .search-placeholder {
            opacity: 0;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--muted);
            font-size: 16px;
        }

        .search-results {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-top: 8px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            position: relative;
            z-index: 100;
        }

        .search-results.active {
            display: block;
        }

        .search-result {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }

        .search-result:hover {
            background: var(--hover);
        }

        .search-result:last-child {
            border-bottom: none;
        }

        .result-type {
            font-size: 11px;
            color: var(--muted);
            text-transform: uppercase;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .result-title {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .result-preview {
            font-size: 12px;
            color: var(--muted);
            line-height: 1.3;
        }

        /* Табы */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
        }

        .tab {
            flex: 1;
            background: none;
            border: none;
            padding: 12px 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: var(--muted);
            position: relative;
        }

        .tab.active {
            color: var(--primary);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
        }

        /* Содержимое табов */
        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .panel {
            display: none;
        }

        .panel.active {
            display: block;
        }

        /* Элементы списков */
        .list-item {
            padding: 12px;
            margin-bottom: 4px;
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .list-item:hover {
            border-color: var(--primary);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .list-item.selected {
            border-color: var(--primary);
            background: rgba(26, 115, 232, 0.04);
        }

        .item-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .list-item:hover .item-actions {
            opacity: 1;
        }

        .action-btn {
            background: var(--hover);
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: var(--border);
            transform: scale(1.1);
        }

        .action-btn.edit {
            color: var(--primary);
        }

        .action-btn.delete {
            color: var(--danger);
        }

        .action-btn.delete:hover {
            background: var(--danger);
            color: white;
        }

        /* Подсветка поиска */
        mark {
            background: rgba(255, 204, 0, 0.3);
            color: inherit;
            padding: 1px 2px;
            border-radius: 2px;
        }

        .item-title {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .item-meta {
            font-size: 12px;
            color: var(--muted);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-category {
            background: var(--primary);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 500;
        }

        .category-study { background: #34a853; }
        .category-prayer { background: #9c27b0; }
        .category-sermon { background: #ff9800; }
        .category-personal { background: #e91e63; }

        /* Основная область - ЧАТ */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg);
            position: relative;
        }

        .menu-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 16px;
            display: none;
            z-index: 50;
        }

        .main-content.sidebar-collapsed .menu-toggle {
            display: block;
        }

        /* CHAT HEADER */
        .chat-header {
            padding: 12px 16px; 
            border-bottom: 1px solid var(--border);
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            gap: 12px;
            background: var(--card);
        }

        .chat-title {
            font-size: 16px; 
            font-weight: 600; 
            margin: 0;
            flex: 1;
        }

        .chat-subtitle {
            font-size: 9px !important;
            margin-top: 1px !important;
            color: var(--muted);
        }

        /* CONTROLS PANEL */
        .controls {
            padding: 12px 16px; 
            background: var(--card); 
            border-bottom: 1px solid var(--border);
            display: grid; 
            grid-template-columns: 1fr 120px 80px; 
            gap: 8px; 
            align-items: center;
            transition: all 0.3s ease;
            overflow: hidden;
            max-height: 200px;
        }

        .controls.hidden {
            max-height: 0;
            padding: 0 16px;
            opacity: 0;
            border-bottom: none;
            margin: 0;
        }

        .controls.visible {
            max-height: 200px;
            padding: 12px 16px;
            opacity: 1;
            margin: 0;
        }

        .model-select { 
            width: 100%; 
            padding: 8px 10px; 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            background: var(--bg);
            color: var(--text);
        }

        .help-btn, .theme-btn, .clear-btn {
            padding: 8px 12px; 
            border: 0; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600;
            background: var(--hover); 
            color: var(--text);
            font-size: 12px;
        }

        .clear-btn {
            background: var(--danger);
            color: white;
        }

        /* CONTROLS TOGGLE BUTTON */
        .controls-toggle-btn {
            background: none; 
            border: none; 
            font-size: 16px;
            cursor: pointer; 
            padding: 8px; 
            color: var(--text);
            border-radius: 6px; 
            transition: all 0.2s ease;
            margin-left: 8px;
        }

        .controls-toggle-btn:hover {
            background: var(--hover);
        }

        /* CHAT AREA */
        .chat-area {
            flex: 1; 
            padding: 16px; 
            overflow-y: auto; 
            background: var(--bg);
        }

        .msg { 
            margin: 8px 0 16px; 
            line-height: 1.5; 
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .role { 
            font-weight: 700; 
            min-width: 25px;
        }

        .ai .role { 
            color: var(--primary); 
        }

        .you .role { 
            color: var(--success); 
        }

        .msg-text {
            flex: 1;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .bible-ref { 
            color: var(--primary); 
            text-decoration: underline; 
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .bible-ref:hover {
            background-color: rgba(26, 115, 232, 0.1);
            border-radius: 3px;
        }

        a.inline { 
            color: var(--primary); 
            text-decoration: underline; 
            word-break: break-all; 
        }

        /* INPUT AREA */
        .input-area {
            padding: 16px; 
            background: var(--card); 
            border-top: 1px solid var(--border);
            display: grid; 
            grid-template-columns: 1fr auto auto auto; 
            gap: 10px;
            align-items: center;
        }

        .user-input { 
            padding: 12px; 
            font-size: 16px; 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            background: var(--bg);
            color: var(--text);
            outline: none;
        }

        .send-btn { 
            padding: 10px 16px; 
            border: 0; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600; 
            background: var(--success); 
            color: #fff; 
        }

        .send-btn:disabled { 
            opacity: .6; 
            cursor: not-allowed; 
        }

        .session-btn {
            padding: 10px 12px;
            border: 0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            background: var(--primary);
            color: white;
            font-size: 12px;
        }

        .note-btn {
            padding: 10px 12px;
            border: 0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            background: var(--accent);
            color: var(--text);
            font-size: 12px;
        }

        /* Кнопки действий в сайдбаре */
        .action-buttons {
            padding: 16px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
        }

        .btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-secondary {
            background: var(--hover);
            color: var(--text);
        }

        .btn:hover {
            opacity: 0.9;
        }

        /* Пустое состояние */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--muted);
        }

        .empty-state h3 {
            margin: 0 0 8px;
            font-size: 16px;
            font-weight: 500;
            color: var(--text);
        }

        .empty-state p {
            margin: 0;
            font-size: 14px;
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                left: 0;
                top: 0;
                height: 100%;
                z-index: 1000;
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content .menu-toggle {
                display: block;
            }

            .overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 999;
                display: none;
            }

            .overlay.active {
                display: block;
            }

            .controls {
                padding: 12px 16px;
                grid-template-columns: 1fr;
                gap: 12px;
                max-height: 180px;
            }
            
            .controls.hidden {
                max-height: 0;
                padding: 0 16px;
                margin: 0;
                border: none;
            }
            
            .model-select {
                width: 100%;
                padding: 12px;
                font-size: 14px;
                appearance: none;
                -webkit-appearance: none;
                background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23666'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
                background-repeat: no-repeat;
                background-position: right 10px center;
                background-size: 12px;
                padding-right: 30px;
            }
            
            .controls-row2 {
                display: flex;
                gap: 8px;
                justify-content: center;
            }
            
            .help-btn, .theme-btn, .clear-btn {
                flex: 1;
                padding: 10px;
                font-size: 14px;
            }
            
            .controls-toggle-btn {
                font-size: 20px;
                padding: 10px;
            }
            
            .chat-area {
                padding: 12px;
            }
            
            .input-area {
                padding: 12px;
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .user-input {
                padding: 12px;
                font-size: 16px;
            }
            
            .send-btn, .session-btn, .note-btn {
                padding: 12px;
                width: 100%;
            }
        }

        /* Модальные окна */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card);
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h2, .modal h3 {
            margin: 0 0 16px;
            font-size: 18px;
            color: var(--text);
        }

        .modal-footer {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 16px;
        }

        .form-group {
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }

        .form-group.hidden {
            display: none;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 6px;
            font-size: 14px;
            color: var(--text);
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            background: var(--bg);
            color: var(--text);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            border: 0;
            border-radius: 8px;
            padding: 10px 16px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Bible modal */
        .verse-content {
            line-height: 1.6;
            font-size: 16px;
            margin: 16px 0;
            color: var(--text);
        }

        .verse-content b {
            color: var(--primary);
            margin-right: 4px;
        }

        /* Loading state */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
            margin-left: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Scroll */
        .chat-area::-webkit-scrollbar,
        .tab-content::-webkit-scrollbar {
            width: 6px;
        }

        .chat-area::-webkit-scrollbar-track,
        .tab-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-area::-webkit-scrollbar-thumb,
        .tab-content::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        /* Темная тема */
        [data-theme="dark"] .sidebar {
            background: var(--card);
        }

        [data-theme="dark"] .list-item {
            background: var(--hover);
        }

        [data-theme="dark"] .search-results {
            background: var(--card);
            color: var(--text);
        }

        [data-theme="dark"] .search-input {
            background: var(--hover);
            color: var(--text);
        }

        [data-theme="dark"] .search-input:focus {
            background: var(--bg);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Боковая панель -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2 class="sidebar-title">📖 Біблія Асистент</h2>
                <button class="collapse-btn" onclick="toggleSidebar()">‹</button>
            </div>

            <!-- Поиск в активной вкладке -->
            <div class="search-container">
                <div class="search-box">
                    <div class="search-icon">🔍</div>
                    <input type="text" 
                           class="search-input" 
                           id="contextSearch"
                           oninput="performContextSearch(this.value)"
                           placeholder="">
                    <div class="search-placeholder" id="searchPlaceholder">Пошук у сесіях...</div>
                </div>
                <div class="search-results" id="searchResults"></div>
            </div>

            <!-- Табы -->
            <div class="tabs">
                <button class="tab active" data-tab="sessions" onclick="switchTab('sessions')">
                    📝 Сесії
                </button>
                <button class="tab" data-tab="notes" onclick="switchTab('notes')">
                    🔖 Нотатки
                </button>
            </div>

            <!-- Содержимое -->
            <div class="tab-content">
                <!-- Панель сессий -->
                <div class="panel active" id="sessions-panel">
                    <div id="sessions-list"></div>
                    <div class="empty-state" id="sessions-empty" style="display: none;">
                        <h3>Немає сесій</h3>
                        <p>Створіть нову сесію для початку роботи</p>
                    </div>
                </div>

                <!-- Панель заметок -->
                <div class="panel" id="notes-panel">
                    <div id="notes-list"></div>
                    <div class="empty-state" id="notes-empty" style="display: none;">
                        <h3>Немає нотаток</h3>
                        <p>Створіть нотатку або закладку</p>
                    </div>
                </div>
            </div>

            <!-- Кнопки действий -->
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="createNew()">
                    ➕ Створити
                </button>
                <button class="btn btn-secondary" onclick="showOptions()">
                    📁 Файл
                </button>
            </div>
        </div>

        <!-- Основная область - ЧАТ -->
        <div class="main-content" id="mainContent">
            <button class="menu-toggle" onclick="toggleSidebar()">☰</button>
            
            <!-- Chat Header -->
            <header class="chat-header">
                <div style="flex: 1; min-width: 0;">
                    <h1 class="chat-title">Біблійний чат</h1>
                    <div class="chat-subtitle">
                        Біблія Асистент • ЄХБ м.Суми, Україна
                    </div>
                </div>
                <button class="controls-toggle-btn" id="controlsToggleBtn" onclick="toggleControls()" title="Показати налаштування">⚙️</button>
            </header>

            <!-- Controls Panel -->
            <section class="controls visible" id="controls">
                <select class="model-select" id="model" title="Модель AI"></select>
                <div id="controls-row2">
                    <button class="help-btn" onclick="showHelpModal()">🆘 Допомога</button>
                    <button class="theme-btn" id="themeBtn" onclick="toggleTheme()">🌙 Тема</button>
                    <button class="clear-btn" onclick="clearChatConfirm()">🗑️ Очистити</button>
                </div>
            </section>

            <!-- Chat Area -->
            <section class="chat-area" id="chatArea" aria-live="polite"></section>

            <!-- Input Area -->
            <section class="input-area">
                <input class="user-input" id="userInput" type="text" placeholder="Напишіть запитання про Біблію..." />
                <button class="session-btn" id="sessionBtn" onclick="saveAsSession()" title="Зберегти як сесію">💾</button>
                <button class="note-btn" id="noteBtn" onclick="saveAsNote()" title="Створити нотатку">📝</button>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">Надіслати</button>
            </section>
        </div>
    </div>

    <!-- Оверлей для мобильных -->
    <div class="overlay" id="overlay" onclick="closeSidebar()"></div>

    <!-- Модальное окно создания -->
    <div class="modal" id="createModal">
        <div class="modal-content">
            <h3>Створити нову</h3>
            <div class="form-group">
                <label class="form-label">Тип:</label>
                <select class="form-select" id="createType" onchange="toggleCreateFields()">
                    <option value="session">📝 Нова сесія</option>
                    <option value="note">📖 Нотатка</option>
                    <option value="bookmark">🔖 Закладка</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Назва:</label>
                <input type="text" class="form-input" id="createTitle" placeholder="Введіть назву...">
            </div>

            <div id="noteFields" style="display: none;">
                <div class="form-group">
                    <label class="form-label">Категорія:</label>
                    <select class="form-select" id="createCategory">
                        <option value="study">📖 Вивчення</option>
                        <option value="prayer">🙏 Молитва</option>
                        <option value="sermon">🎤 Проповідь</option>
                        <option value="personal">💭 Особисте</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Біблійна посилання:</label>
                    <input type="text" class="form-input" id="createReference" placeholder="напр: Пс. 23:1-6">
                </div>

                <div class="form-group">
                    <label class="form-label">Зміст:</label>
                    <textarea class="form-textarea" id="createContent" placeholder="Введіть текст..."></textarea>
                </div>
            </div>

            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Скасувати</button>
                <button class="btn btn-primary" onclick="createItem()">Створити</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно редактирования сессии -->
    <div class="modal" id="editSessionModal">
        <div class="modal-content">
            <h3>Редагувати сесію</h3>
            <div class="form-group">
                <label class="form-label">Назва:</label>
                <input type="text" class="form-input" id="editSessionTitle" placeholder="Введіть назву сесії...">
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Скасувати</button>
                <button class="btn-danger" onclick="confirmDeleteCurrentSession()">Видалити</button>
                <button class="btn btn-primary" onclick="saveSessionEdit()">Зберегти</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно редактирования заметки -->
    <div class="modal" id="editNoteModal">
        <div class="modal-content">
            <h3>Редагувати нотатку</h3>
            <div class="form-group">
                <label class="form-label">Назва:</label>
                <input type="text" class="form-input" id="editNoteTitle" placeholder="Введіть назву...">
            </div>
            
            <div id="editNoteFields">
                <div class="form-group">
                    <label class="form-label">Категорія:</label>
                    <select class="form-select" id="editNoteCategory" onchange="toggleEditNoteFields()">
                        <option value="">🔖 Закладка</option>
                        <option value="study">📖 Вивчення</option>
                        <option value="prayer">🙏 Молитва</option>
                        <option value="sermon">🎤 Проповідь</option>
                        <option value="personal">💭 Особисте</option>
                    </select>
                </div>

                <div class="form-group" id="editNoteReferenceGroup">
                    <label class="form-label">Біблійна посилання:</label>
                    <input type="text" class="form-input" id="editNoteReference" placeholder="напр: Пс. 23:1-6">
                </div>

                <div class="form-group" id="editNoteContentGroup">
                    <label class="form-label">Зміст:</label>
                    <textarea class="form-textarea" id="editNoteContent" placeholder="Введіть текст..."></textarea>
                </div>
            </div>

            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Скасувати</button>
                <button class="btn-danger" onclick="confirmDeleteCurrentNote()">Видалити</button>
                <button class="btn btn-primary" onclick="saveNoteEdit()">Зберегти</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно опций -->
    <div class="modal" id="optionsModal">
        <div class="modal-content">
            <h3>Опції</h3>
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <button class="btn btn-secondary" onclick="exportData()">📤 Експорт даних</button>
                <button class="btn btn-secondary" onclick="importData()">📥 Імпорт даних</button>
                <button class="btn btn-secondary" onclick="clearAll()">🗑️ Очистити все</button>
                <button class="btn btn-primary" onclick="closeModal()">Закрити</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно помощи -->
    <div class="modal" id="helpModal">
        <div class="modal-content">
            <h2>📚 Допомога</h2>
            <div style="line-height: 1.6; font-size: 14px;">
                <h3>📖 Біблійні посилання</h3>
                <p>• Клікніть на будь-яке посилання на Біблію щоб побачити текст</p>
                <p>• Підтримуються формати: (Пс. 23:1), (Буття 1:1-3), (Ів. 3:16)</p>
                <p>• Можна переглядати всю главу цілком</p>
                
                <h3>💡 Приклади питань</h3>
                <p>• "Надрукуй Псалом 23 повністю"</p>
                <p>• "Поясни притчу про блудного сина"</p>
                <p>• "Порівняй Івана 3:16 у різних перекладах"</p>
                
                <h3>💾 Сесії та нотатки</h3>
                <p>• Зберігайте розмови як сесії</p>
                <p>• Створюйте нотатки з важливими думками</p>
                <p>• Додавайте закладки до цікавих моментів</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeModal()">Зрозуміло!</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно с библейскими стихами -->
    <div class="modal" id="verseModal">
    </div>

    <script>
 /* =========================
  BIBLE REFERENCES HANDLING
  ========================= */

// Единый массив всех книг с альтернативными названиями
const BOOK_NAMES = [
    ["Буття", "Бут."],
    ["Вихід", "Вих."],
    ["Левіт", "Лев."],
    ["Числа", "Чис."],
    ["Второзаконня", "Втор."],
    ["Ісуса Навина", "Нав.", "Ісус Навин"],
    ["Суддів", "Суд.", "Судді"],
    ["Рути", "Рут.", "Рут"],
    ["1 Самуїлова", "1 Сам.", "1Сам."],
    ["2 Самуїлова", "2 Сам.", "2Сам."],
    ["1 Царів", "1 Цар.", "1Цар."],
    ["2 Царів", "2 Цар.", "2Цар."],
    ["1 Хронік", "1 Хр.", "1Хр."],
    ["2 Хронік", "2 Хр.", "2Хр."],
    ["Ездри", "Езд.", "Ездра", "Ездр."],
    ["Неємії", "Неєм.", "Неемія", "Неем."],
    ["Есфирі", "Есф.", "Естер", "Ест."],
    ["Йова", "Йов."],
    ["Псалми", "Пс.", "Псалом"],
    ["Приповісті Соломонові", "Прип.", "Приповісті", "Пр."],
    ["Екклезіаст", "Еккл.", "Екклезіяст", "Екл."],
    ["Пісня Соломона", "Піс.", "Пісня над піснями", "Пісн."],
    ["Ісаї", "Іс.", "Ісая"],
    ["Єремії", "Єр."],
    ["Плач Єремії", "Плач", "Пл.Єр."],
    ["Єзекиїла", "Єз.", "Єзекіїль"],
    ["Даниїла", "Дан.", "Даниїл"],
    ["Осії", "Ос.", "Осія"],
    ["Йоіла", "Йоіл.", "Йоіл"],
    ["Амоса", "Ам.", "Амос"],
    ["Авдія", "Авд.", "Овдій", "Овд."],
    ["Йони", "Йона", "Йон."],
    ["Михея", "Мих.", "Михей"],
    ["Наума", "Наум"],
    ["Авакума", "Ав.", "Авакум"],
    ["Софонії", "Соф.", "Софонія"],
    ["Аггея", "Агг.", "Огій", "Ог."],
    ["Захарії", "Зах.", "Захарія"],
    ["Малахії", "Мал.", "Малахія"],
    ["Матвія", "Матв.", "Мт."],
    ["Марка", "Марк.", "Мр."],
    ["Луки", "Лук.", "Лк."],
    ["Івана", "Ів."],
    ["Дії апостолів", "Дії", "Дії Апостолів"],
    ["Римлян", "Рим."],
    ["1 Коринтян", "1 Кор.", "1Кор."],
    ["2 Коринтян", "2 Кор.", "2Кор."],
    ["Галатів", "Гал."],
    ["Ефесян", "Еф."],
    ["Филипян", "Фил.", "Филип'ян"],
    ["Колоссян", "Кол.", "Колосян"],
    ["1 Солунян", "1 Сол.", "1Сол."],
    ["2 Солунян", "2 Сол.", "2Сол."],
    ["1 Тимофія", "1 Тим.", "1Тим."],
    ["2 Тимофія", "2 Тим.", "2Тим."],
    ["Тита", "Тит"],
    ["Филимона", "Филм.", "Флм."],
    ["Євреїв", "Євр."],
    ["Якова", "Як."],
    ["1 Петра", "1 Пет.", "1Пет."],
    ["2 Петра", "2 Пет.", "2Пет."],
    ["1 Івана", "1 Ів.", "1Ів."],
    ["2 Івана", "2 Ів.", "2Ів."],
    ["3 Івана", "3 Ів.", "3Ів."],
    ["Юди", "Юд."],
    ["Об'явлення Івана Богослова", "Об'явл."]
];

// Создаем Map для быстрого поиска
const BOOK_INDEX_MAP = new Map();
BOOK_NAMES.forEach((bookVariants, index) => {
    bookVariants.forEach(variant => {
        BOOK_INDEX_MAP.set(variant, index + 1);
        BOOK_INDEX_MAP.set(variant.replace(/\.$/, ""), index + 1);
    });
});

// Формируем строку для промпта
const BOOKS_LIST_FOR_PROMPT = BOOK_NAMES
    .map(variants => variants.join(", "))
    .join("; ");

// Улучшенная функция поиска номера книги
function getBookNumber(bookName) {
    if (!bookName) return null;
    
    const normalized = bookName.trim();
    
    if (BOOK_INDEX_MAP.has(normalized)) {
        return BOOK_INDEX_MAP.get(normalized);
    }
    
    const withoutDot = normalized.replace(/\.$/, "");
    if (BOOK_INDEX_MAP.has(withoutDot)) {
        return BOOK_INDEX_MAP.get(withoutDot);
    }
    
    const lowerNormalized = normalized.toLowerCase();
    for (let [key, value] of BOOK_INDEX_MAP) {
        if (key.toLowerCase() === lowerNormalized) {
            return value;
        }
    }
    
    return null;
}

/* =========================
  API & SETTINGS
  ========================= */
const encrypted = "Z3NrX1NUelQyS1FFQko3MGNDb1hDSllaV0dkeWIzRlk5OHJHN2xvWXUxSmc1SnV0VFZOSzIyVHY=";
const apiKey = atob(encrypted);
const API_BASE = "https://api.groq.com/openai/v1";
const API_URL = `${API_BASE}/chat/completions`;
const MODELS_URL = `${API_BASE}/models`;

const DEFAULT_PROMPT = `Ти — асистент-богослов і знавець Біблії. Відповідай стисло, точно і з повагою.

ВАЖЛИВО! При згадуванні біблійних книг використовуй ТІЛЬКИ ці назви:
${BOOKS_LIST_FOR_PROMPT}

Дотримуйся цих правил:
- Завжди тримайся біблійної теми, уникай оффтопу.
- Якщо наводиш цитати, вказуй книгу, розділ і вірші у форматі (Книга число:число).
- За можливості пояснюй контекст (хто говорить, кому, у якій ситуації).
- Використовуй переклад Огієнка як основний при цитуванні.
- При згадуванні біблійних джерел ЗАВЖДИ використовуй формат (Книга число:число) у круглих дужках.
- Коли доречно, додавай порівняння з іншими українськими перекладами і коротко коментуй різницю.
- Коротко додавай богословські коментарі, чітко відділяючи їх від тексту Писання.
- Відповідай українською мовою.
- Подавай цитати з номерами віршів і завжди вказуй джерело у круглих дужках після цитати.
- НЕ вигадуй інших назв книг, крім зазначених вище!`;

const SETTINGS = {
    systemPrompt: DEFAULT_PROMPT,
    defaultModel: "meta-llama/llama-4-maverick-17b-128e-instruct",
    temperature: 0.7,
    maxTokens: 1500,
    highlightRefs: true,
    boldKeywords: true,
    keywords: "віра, благодать, спасіння, любов, прощення"
};

/* =========================
  GLOBAL STATE
  ========================= */
let messages = [{ role: "system", content: SETTINGS.systemPrompt }];
let isLoading = false;
let currentSessionId = null;

// Данные приложения (используем память вместо localStorage для Claude.ai)
let appData = {
    sessions: [],
    notes: [],
    currentTab: 'sessions',
    selectedItem: null
};

/* =========================
  SESSION & NOTES MANAGEMENT
  ========================= */

// Новая функция для управления полями редактирования заметки
function toggleEditNoteFields() {
    const category = document.getElementById('editNoteCategory').value;
    const referenceGroup = document.getElementById('editNoteReferenceGroup');
    const contentGroup = document.getElementById('editNoteContentGroup');
    
    if (category === '') {
        // Это закладка - скрываем поля
        referenceGroup.classList.add('hidden');
        contentGroup.classList.add('hidden');
    } else {
        // Это заметка - показываем поля
        referenceGroup.classList.remove('hidden');
        contentGroup.classList.remove('hidden');
    }
}

// Контекстный поиск (в рамках активной вкладки)
function performContextSearch(query) {
    const results = document.getElementById('searchResults');
    const searchInput = document.getElementById('contextSearch');
    
    if (!query.trim()) {
        results.classList.remove('active');
        // Показываем все элементы
        renderCurrentTab();
        return;
    }

    const searchResults = [];
    query = query.toLowerCase();

    if (appData.currentTab === 'sessions') {
        // Поиск только в сессиях
        appData.sessions.forEach(session => {
            if (session.title.toLowerCase().includes(query)) {
                searchResults.push({
                    type: 'сесія',
                    id: session.id,
                    title: session.title,
                    preview: `${session.messageCount} повідомлень • ${formatDate(session.modified)}`
                });
            }
        });
    } else {
        // Поиск только в заметках
        appData.notes.forEach(note => {
            if (note.title.toLowerCase().includes(query) || 
                note.content.toLowerCase().includes(query) ||
                (note.bibleRef && note.bibleRef.toLowerCase().includes(query))) {
                searchResults.push({
                    type: note.type === 'bookmark' ? 'закладка' : 'нотатка',
                    id: note.id,
                    title: note.title,
                    preview: note.content ? note.content.substring(0, 60) + '...' : note.bibleRef
                });
            }
        });
    }

    renderContextSearchResults(searchResults, query);
}

function renderContextSearchResults(results, query) {
    const container = document.getElementById('searchResults');
    
    if (results.length === 0) {
        container.innerHTML = '<div class="search-result"><div class="result-preview">Нічого не знайдено</div></div>';
    } else {
        container.innerHTML = results.map(result => `
            <div class="search-result" onclick="selectContextSearchResult('${result.id}')">
                <div class="result-type">${result.type}</div>
                <div class="result-title">${highlightSearchTerm(result.title, query)}</div>
                <div class="result-preview">${result.preview}</div>
            </div>
        `).join('');
    }
    
    container.classList.add('active');
}

function highlightSearchTerm(text, term) {
    if (!term) return text;
    const regex = new RegExp(`(${term})`, 'gi');
    return text.replace(regex, '<mark>$1</mark>');
}

function selectContextSearchResult(id) {
    document.getElementById('searchResults').classList.remove('active');
    document.getElementById('contextSearch').value = '';
    
    if (appData.currentTab === 'sessions') {
        selectSession(id);
    } else {
        selectNote(id);
    }
}

function updateSearchPlaceholder() {
    const placeholder = document.getElementById('searchPlaceholder');
    if (appData.currentTab === 'sessions') {
        placeholder.textContent = 'Пошук у сесіях...';
    } else {
        placeholder.textContent = 'Пошук у нотатках...';
    }
}

// Переключение табов
function switchTab(tabName) {
    // Обновляем активный таб
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

    // Показываем соответствующую панель
    document.querySelectorAll('.panel').forEach(panel => panel.classList.remove('active'));
    document.getElementById(`${tabName}-panel`).classList.add('active');

    appData.currentTab = tabName;
    
    // Обновляем плейсхолдер поиска
    updateSearchPlaceholder();
    
    // Очищаем поиск при переключении
    document.getElementById('contextSearch').value = '';
    document.getElementById('searchResults').classList.remove('active');
    
    renderCurrentTab();
}

function renderCurrentTab() {
    if (appData.currentTab === 'sessions') {
        renderSessions();
    } else {
        renderNotes();
    }
}

function renderSessions() {
    const container = document.getElementById('sessions-list');
    const empty = document.getElementById('sessions-empty');

    if (appData.sessions.length === 0) {
        container.innerHTML = '';
        empty.style.display = 'block';
        return;
    }

    empty.style.display = 'none';
    container.innerHTML = appData.sessions.map(session => `
        <div class="list-item ${appData.selectedItem === session.id ? 'selected' : ''}" 
             onclick="selectSession('${session.id}')">
            <div class="item-actions">
                <button class="action-btn edit" onclick="event.stopPropagation(); editSession('${session.id}')" title="Редагувати">
                    ✏️
                </button>
                <button class="action-btn delete" onclick="event.stopPropagation(); deleteSession('${session.id}')" title="Видалити">
                    🗑️
                </button>
            </div>
            <div class="item-title">${session.title}</div>
            <div class="item-meta">
                <span>${session.messageCount} повідомлень</span>
                <span>${formatDate(session.modified)}</span>
            </div>
        </div>
    `).join('');
}

function renderNotes() {
    const container = document.getElementById('notes-list');
    const empty = document.getElementById('notes-empty');

    if (appData.notes.length === 0) {
        container.innerHTML = '';
        empty.style.display = 'block';
        return;
    }

    empty.style.display = 'none';
    container.innerHTML = appData.notes.map(note => {
        const categoryNames = {
            study: '📖 Вивчення',
            prayer: '🙏 Молитва',
            sermon: '🎤 Проповідь',
            personal: '💭 Особисте'
        };

        return `
            <div class="list-item ${appData.selectedItem === note.id ? 'selected' : ''}" 
                 onclick="selectNote('${note.id}')">
                <div class="item-actions">
                    <button class="action-btn edit" onclick="event.stopPropagation(); editNote('${note.id}')" title="Редагувати">
                        ✏️
                    </button>
                    <button class="action-btn delete" onclick="event.stopPropagation(); deleteNote('${note.id}')" title="Видалити">
                        🗑️
                    </button>
                </div>
                <div class="item-title">${note.title}</div>
                ${note.content ? `<div class="result-preview">${note.content.substring(0, 80)}...</div>` : ''}
                <div class="item-meta">
                    ${note.category ? `<span class="item-category category-${note.category}">${categoryNames[note.category]}</span>` : 
                      `<span class="item-category">🔖 Закладка</span>`}
                    <span>${formatDate(note.created)}</span>
                </div>
            </div>
        `;
    }).join('');
}

function selectSession(id) {
    const session = appData.sessions.find(s => s.id === id);
    if (!session) return;
    
    appData.selectedItem = id;
    currentSessionId = id;
    renderSessions();
    
    // Загружаем сообщения сессии, если есть
    if (session.messages && session.messages.length > 0) {
        loadSessionMessages(session.messages);
    }
    
    console.log('Выбрана сессия:', id);
}

function selectNote(id) {
    appData.selectedItem = id;
    renderNotes();
    console.log('Выбрана заметка:', id);
}

/* =========================
  MODAL MANAGEMENT
  ========================= */

let currentEditingSessionId = null;
let currentEditingNoteId = null;

// Управление боковой панелью
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    const overlay = document.getElementById('overlay');

    if (window.innerWidth <= 768) {
        sidebar.classList.toggle('open');
        overlay.classList.toggle('active');
    } else {
        sidebar.classList.toggle('collapsed');
        mainContent.classList.toggle('sidebar-collapsed');
    }
}

function closeSidebar() {
    document.getElementById('sidebar').classList.remove('open');
    document.getElementById('overlay').classList.remove('active');
}

// Создание нового элемента
function createNew() {
    const modal = document.getElementById('createModal');
    modal.classList.add('active');
    
    // Устанавливаем тип по умолчанию в зависимости от активного таба
    const typeSelect = document.getElementById('createType');
    typeSelect.value = appData.currentTab === 'sessions' ? 'session' : 'note';
    toggleCreateFields();
}

function toggleCreateFields() {
    const type = document.getElementById('createType').value;
    const noteFields = document.getElementById('noteFields');
    noteFields.style.display = type === 'session' ? 'none' : 'block';
}

function createItem() {
    const type = document.getElementById('createType').value;
    const title = document.getElementById('createTitle').value.trim();
    
    if (!title) {
        alert('Введіть назву!');
        return;
    }

    const newItem = {
        id: `${type}_${Date.now()}`,
        title: title,
        created: Date.now(),
        modified: Date.now()
    };

    if (type === 'session') {
        newItem.messageCount = 0;
        newItem.messages = [{ role: "system", content: SETTINGS.systemPrompt }];
        appData.sessions.unshift(newItem);
        switchTab('sessions');
        appData.selectedItem = newItem.id;
        currentSessionId = newItem.id;
        
        // Очищаем чат и показываем приветствие
        clearChatArea();
        showWelcomeMessage();
    } else {
        newItem.type = type;
        newItem.content = document.getElementById('createContent').value.trim();
        newItem.category = type === 'bookmark' ? null : document.getElementById('createCategory').value;
        newItem.bibleRef = document.getElementById('createReference').value.trim();
        newItem.sessionId = currentSessionId;
        
        appData.notes.unshift(newItem);
        switchTab('notes');
        appData.selectedItem = newItem.id;
    }

    saveData();
    renderCurrentTab();
    closeModal();
}

// Управление сессиями
function editSession(id) {
    const session = appData.sessions.find(s => s.id === id);
    if (!session) return;

    currentEditingSessionId = id;
    document.getElementById('editSessionTitle').value = session.title;
    document.getElementById('editSessionModal').classList.add('active');
}

function saveSessionEdit() {
    if (!currentEditingSessionId) return;

    const title = document.getElementById('editSessionTitle').value.trim();
    if (!title) {
        alert('Введіть назву сесії!');
        return;
    }

    const session = appData.sessions.find(s => s.id === currentEditingSessionId);
    if (session) {
        session.title = title;
        session.modified = Date.now();
        saveData();
        renderSessions();
        closeModal();
    }
}

function deleteSession(id) {
    if (confirm('Видалити сесію? Усі повідомлення будуть втрачені!')) {
        appData.sessions = appData.sessions.filter(s => s.id !== id);
        
        // Удаляем связанные заметки
        appData.notes = appData.notes.filter(n => n.sessionId !== id);
        
        if (appData.selectedItem === id) {
            appData.selectedItem = null;
            currentSessionId = null;
            clearChatArea();
            showWelcomeMessage();
        }
        
        saveData();
        renderSessions();
        if (appData.currentTab === 'notes') {
            renderNotes(); // Обновляем заметки, если показываются
        }
    }
}

function confirmDeleteCurrentSession() {
    if (currentEditingSessionId) {
        closeModal();
        deleteSession(currentEditingSessionId);
    }
}

// Управление заметками
function editNote(id) {
    const note = appData.notes.find(n => n.id === id);
    if (!note) return;

    currentEditingNoteId = id;
    document.getElementById('editNoteTitle').value = note.title;
    document.getElementById('editNoteCategory').value = note.category || '';
    document.getElementById('editNoteReference').value = note.bibleRef || '';
    document.getElementById('editNoteContent').value = note.content || '';
    
    // Показываем/скрываем поля в зависимости от категории
    toggleEditNoteFields();
    
    document.getElementById('editNoteModal').classList.add('active');
}

function saveNoteEdit() {
    if (!currentEditingNoteId) return;

    const title = document.getElementById('editNoteTitle').value.trim();
    if (!title) {
        alert('Введіть назву нотатки!');
        return;
    }

    const note = appData.notes.find(n => n.id === currentEditingNoteId);
    if (note) {
        note.title = title;
        const category = document.getElementById('editNoteCategory').value || null;
        note.category = category;
        
        if (category) {
            // Это заметка - сохраняем все поля
            note.bibleRef = document.getElementById('editNoteReference').value.trim();
            note.content = document.getElementById('editNoteContent').value.trim();
            note.type = 'note';
        } else {
            // Это закладка - очищаем поля содержимого
            note.bibleRef = '';
            note.content = '';
            note.type = 'bookmark';
        }
        
        note.modified = Date.now();
        
        saveData();
        renderNotes();
        closeModal();
    }
}

function deleteNote(id) {
    const note = appData.notes.find(n => n.id === id);
    if (!note) return;

    const typeName = note.type === 'bookmark' ? 'закладку' : 'нотатку';
    if (confirm(`Видалити ${typeName} "${note.title}"?`)) {
        appData.notes = appData.notes.filter(n => n.id !== id);
        
        if (appData.selectedItem === id) {
            appData.selectedItem = null;
        }
        
        saveData();
        renderNotes();
    }
}

function confirmDeleteCurrentNote() {
    if (currentEditingNoteId) {
        closeModal();
        deleteNote(currentEditingNoteId);
    }
}

function closeModal() {
    document.querySelectorAll('.modal').forEach(modal => {
        modal.classList.remove('active');
    });
    
    // Очищаем формы
    document.getElementById('createTitle').value = '';
    document.getElementById('createContent').value = '';
    document.getElementById('createReference').value = '';
    
    // Убираем скрытие полей в форме редактирования
    const editNoteReferenceGroup = document.getElementById('editNoteReferenceGroup');
    const editNoteContentGroup = document.getElementById('editNoteContentGroup');
    if (editNoteReferenceGroup) editNoteReferenceGroup.classList.remove('hidden');
    if (editNoteContentGroup) editNoteContentGroup.classList.remove('hidden');
    
    // Сбрасываем переменные редактирования
    currentEditingSessionId = null;
    currentEditingNoteId = null;
}

function showOptions() {
    document.getElementById('optionsModal').classList.add('active');
}

function showHelpModal() {
    document.getElementById('helpModal').classList.add('active');
}

// Функция показа модалки с библейским текстом
function showVerseModal(title, content, bookNum, chapter) {
    const modal = document.getElementById("verseModal");
    modal.classList.add("active");
    
    // Проверяем, это диапазон глав или одна глава
    const isChapterRange = title.includes('-') && !title.includes(':');
    
    modal.innerHTML = `
        <div class="modal-content">
            <h2>📖 ${title}</h2>
            <div class="verse-content">${content}</div>
            <div class="modal-footer">
                ${!isChapterRange ? `<button class="btn btn-secondary" id="show-chapter">Показати всю главу</button>` : ''}
                <button class="btn btn-primary" id="close-verse-modal">Закрити</button>
            </div>
        </div>`;
    
    modal.querySelector("#close-verse-modal").addEventListener("click", () => {
        modal.classList.remove("active");
    });
    
    // Кнопка "Показать всю главу" только для стихов, не для диапазона глав
    const showChapterBtn = modal.querySelector("#show-chapter");
    if (showChapterBtn) {
        showChapterBtn.addEventListener("click", async () => {
            const button = showChapterBtn;
            const originalText = button.textContent;
            button.innerHTML = 'Завантаження... <span class="loading-spinner"></span>';
            button.disabled = true;
            
            try {
                const chapterText = await window.bible.getChapterText(bookNum, chapter);
                const formatted = chapterText
                    .replace(/\s*(\d+\.)/g, "<br><b>$1</b>")
                    .replace(/^<br>/, "");
                modal.querySelector(".verse-content").innerHTML = formatted;
                modal.querySelector("h2").textContent = `📖 ${title.split(':')[0]} - вся глава ${chapter}`;
                button.style.display = 'none';
            } catch (error) {
                button.textContent = 'Помилка завантаження';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.disabled = false;
                }, 2000);
            }
        });
    }
    
 modal.addEventListener("click", (e) => {
        if (e.target.id === "verseModal") {
            modal.classList.remove("active");
        }
    });
}

// Обработчик кликов по библейским ссылкам
function attachBibleRefHandlers() {
    document.querySelectorAll(".bible-ref").forEach(el => {
        if (el.dataset.bound) return;
        el.dataset.bound = "1";
        
        el.addEventListener("click", async (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            const refText = el.innerText.trim();
            console.log("Clicked reference:", refText);
            
            // Проверяем формат ссылки - порядок важен!
            // 1. Сначала проверяем стихи (содержит двоеточие)
            const verseMatch = refText.match(/(.+?)\s*(\d+):([\d,\-\s]+)/);
            // 2. Потом проверяем диапазон глав (БЕЗ двоеточия)
            const chapterRangeMatch = !verseMatch && refText.match(/(.+?)\s*(\d+)-(\d+)$/);
            // 3. Проверяем одиночную главу
            const singleChapterMatch = !verseMatch && !chapterRangeMatch && refText.match(/(.+?)\s*(\d+)$/);
            
            if (verseMatch) {
                // Обработка стихов (например, "Бут. 1:1-3", "Луки 15:11-32")
                const [, bookNameRaw, chapter, verseStr] = verseMatch;
                const bookName = bookNameRaw.trim().replace(/\.$/, '');
                const bookNum = getBookNumber(bookName);
                
                if (!bookNum) { 
                    alert("Невідома книга: " + bookName); 
                    return; 
                }

                el.style.opacity = '0.6';
                el.style.cursor = 'wait';

                try {
                    let verses = [];
                    
                    if (verseStr.includes(",") || verseStr.includes("-")) {
                        verses = await window.bible.getVersesRange(bookNum, chapter, verseStr);
                    } else {
                        const v = await window.bible.getVerse(bookNum, chapter, verseStr);
                        if (v) verses = [v];
                    }

                    if (verses.length) {
                        const html = verses.map(v => `<b>${v.number}.</b> ${v.text}`).join("<br>");
                        showVerseModal(`${bookName} ${chapter}:${verseStr}`, html, bookNum, chapter);
                    } else {
                        alert("Стих(и) не знайдено");
                    }
                } catch (error) {
                    console.error("Error loading bible verse:", error);
                    alert("Помилка завантаження тексту Біблії");
                } finally {
                    el.style.opacity = '1';
                    el.style.cursor = 'pointer';
                }
                
            } else if (chapterRangeMatch) {
                // Обработка диапазона глав (например, "Бут. 1-3")
                const [, bookNameRaw, startChapter, endChapter] = chapterRangeMatch;
                const bookName = bookNameRaw.trim().replace(/\.$/, '');
                const bookNum = getBookNumber(bookName);
                
                if (!bookNum) { 
                    alert("Невідома книга: " + bookName); 
                    return; 
                }

                el.style.opacity = '0.6';
                el.style.cursor = 'wait';

                try {
                    let allChaptersText = '';
                    const start = parseInt(startChapter);
                    const end = parseInt(endChapter);
                    
                    for (let chapter = start; chapter <= end; chapter++) {
                        const chapterText = await window.bible.getChapterText(bookNum, chapter);
                        const formatted = chapterText
                            .replace(/\s*(\d+\.)/g, "<br><b>$1</b>")
                            .replace(/^<br>/, "");
                        allChaptersText += `<h3>Глава ${chapter}</h3>${formatted}<br><br>`;
                    }
                    
                    showVerseModal(`${bookName} ${startChapter}-${endChapter}`, allChaptersText, bookNum, start);
                } catch (error) {
                    console.error("Error loading bible chapters:", error);
                    alert("Помилка завантаження тексту Біблії");
                } finally {
                    el.style.opacity = '1';
                    el.style.cursor = 'pointer';
                }
                
            } else if (singleChapterMatch) {
                // Обработка одиночной главы (например, "Бут. 1")
                const [, bookNameRaw, chapter] = singleChapterMatch;
                const bookName = bookNameRaw.trim().replace(/\.$/, '');
                const bookNum = getBookNumber(bookName);
                
                if (!bookNum) { 
                    alert("Невідома книга: " + bookName); 
                    return; 
                }

                el.style.opacity = '0.6';
                el.style.cursor = 'wait';

                try {
                    const chapterText = await window.bible.getChapterText(bookNum, chapter);
                    const formatted = chapterText
                        .replace(/\s*(\d+\.)/g, "<br><b>$1</b>")
                        .replace(/^<br>/, "");
                    showVerseModal(`${bookName} ${chapter}`, formatted, bookNum, chapter);
                } catch (error) {
                    console.error("Error loading bible chapter:", error);
                    alert("Помилка завантаження тексту Біблії");
                } finally {
                    el.style.opacity = '1';
                    el.style.cursor = 'pointer';
                }
                
            } else {
                // Если формат не распознан
                console.log("Unrecognized format:", refText);
                alert("Не вдалося розпізнати формат посилання: " + refText);
            }
        });
    });
}

/* =========================
  UTILITY FUNCTIONS
  ========================= */
function escapeHTML(str) {
    return (str ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
}

function linkify(htmlEscaped) {
    return htmlEscaped.replace(/(https?:\/\/[^\s)<>"]+)/g, '<a class="inline" href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
}

function highlightBibleRefs(htmlEscaped) {
    // Используем улучшенное регулярное выражение из рабочего примера
    // Поддерживает: (Бут. 1:1), (Бут. 1:1-3), (Бут. 1-3), множественные ссылки в скобках
    const bibleRefRegex = /\(?(?:(?:[1-3]\s)?[А-ЯІЄҐ][а-яіїєґ']+(?:\s[А-ЯІЄҐ][а-яіїєґ']+)*\.?\s*\d+(?::\d+(?:-\d+)?|-\d+)?(?:\s*,\s*(?:[1-3]\s)?[А-ЯІЄҐ][а-яіїєґ']+(?:\s[А-ЯІЄҐ][а-яіїєґ']+)*\.?\s*\d+(?::\d+(?:-\d+)?|-\d+)?)*)\)?/g;
    
    return htmlEscaped.replace(bibleRefRegex, (match) => {
        // Проверяем, не является ли уже выделенной частью (избегаем дублирования)
        if (match.includes('<span class="bible-ref">')) {
            return match;
        }
        
        // Обрабатываем множественные ссылки в скобках
        if (match.includes(',')) {
            // Если есть запятые, разбиваем на отдельные ссылки
            const content = match.replace(/[()]/g, ''); // убираем скобки
            const refs = content.split(',').map(ref => ref.trim());
            const highlightedRefs = refs.map(ref => `<span class="bible-ref">${ref}</span>`).join(', ');
            return match.startsWith('(') ? `(${highlightedRefs})` : highlightedRefs;
        } else {
            // Одиночная ссылка
            const cleanRef = match.replace(/[()]/g, '');
            return match.startsWith('(') && match.endsWith(')') 
                ? `(<span class="bible-ref">${cleanRef}</span>)`
                : `<span class="bible-ref">${match}</span>`;
        }
    });
}

function boldifyKeywords(htmlEscaped, keywordsCSV) {
    if (!keywordsCSV) return htmlEscaped;
    const parts = keywordsCSV.split(",").map(s => s.trim()).filter(Boolean);
    if (!parts.length) return htmlEscaped;
    const words = parts.map(w => w.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
    const re = new RegExp(`\\b(${words.join("|")})\\b`, "gi");
    return htmlEscaped.replace(re, '<strong>$1</strong>');
}

function saferFormatAssistant(raw) {
    let out = escapeHTML(raw);
    out = linkify(out);
    if (SETTINGS.highlightRefs) out = highlightBibleRefs(out);
    if (SETTINGS.boldKeywords) out = boldifyKeywords(out, SETTINGS.keywords || "");
    return out.replace(/\n/g, "<br>");
}

/* =========================
  CHAT FUNCTIONS
  ========================= */
function appendMsg(role, htmlOrText, alreadySafeHTML = false) {
    const chat = document.getElementById('chatArea');
    const div = document.createElement('div');
    div.className = `msg ${role === 'assistant' ? 'ai' : 'you'}`;
    const safe = alreadySafeHTML ? htmlOrText : escapeHTML(htmlOrText);
    div.innerHTML = `<span class="role">${role === 'assistant' ? 'AI' : 'Ви'}:</span> <span class="msg-text">${safe}</span>`;
    
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
    
    if (role === 'assistant') {
        setTimeout(() => {
            attachBibleRefHandlers();
        }, 10);
    }
}

function clearChatArea() {
    document.getElementById('chatArea').innerHTML = '';
    messages = [{ role: "system", content: SETTINGS.systemPrompt }];
}

function showWelcomeMessage() {
    appendMsg("assistant", 
        `<span class="muted">🙏 Вітаю! Я - ваш AI асистент для вивчення Біблії. Задавайте будь-які питання про Святе Письмо!</span>`, 
        true
    );
}

function clearChatConfirm() {
    if (confirm('Очистити історію чату?')) {
        clearChatArea();
        showWelcomeMessage();
        
        // Если есть активная сессия, обновляем ее
        if (currentSessionId) {
            const session = appData.sessions.find(s => s.id === currentSessionId);
            if (session) {
                session.messages = [...messages];
                session.messageCount = 0;
                session.modified = Date.now();
                saveData();
                renderSessions();
            }
        }
    }
}

function loadSessionMessages(sessionMessages) {
    clearChatArea();
    messages = [...sessionMessages];
    
    const userMessages = messages.filter(msg => msg.role !== 'system');
    if (userMessages.length === 0) {
        showWelcomeMessage();
    } else {
        userMessages.forEach(msg => {
            if (msg.role === 'user') {
                appendMsg('user', msg.content);
            } else if (msg.role === 'assistant') {
                const formatted = saferFormatAssistant(msg.content);
                appendMsg('assistant', formatted, true);
            }
        });
    }
}

// Утилиты
function formatDate(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diffInHours = Math.floor((now - date) / (1000 * 60 * 60));
    
    if (diffInHours < 1) return 'щойно';
    if (diffInHours < 24) return `${diffInHours} год тому`;
    if (diffInHours < 48) return 'вчора';
    
    return date.toLocaleDateString('uk-UA', { 
        day: 'numeric', 
        month: 'short' 
    });
}

function saveData() {
    // Используем объект в памяти вместо localStorage для совместимости с Claude.ai
    console.log('Данные сохранены:', appData);
}

function loadData() {
    // В Claude.ai artifacts используем данные из памяти
    console.log('Данные загружены:', appData);
}

/* =========================
  API FUNCTIONS
  ========================= */
async function loadModels() {
    const modelSel = document.getElementById('model');
    modelSel.innerHTML = "";
    try {
        const res = await fetch(MODELS_URL, { headers: { "Authorization": `Bearer ${apiKey}` }});
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const models = data?.data || [];

        models.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m.id;
            opt.textContent = m.id;
            modelSel.appendChild(opt);
        });

        if ([...modelSel.options].some(o => o.value === SETTINGS.defaultModel)) {
            modelSel.value = SETTINGS.defaultModel;
        } else if (modelSel.options.length > 0) {
            modelSel.selectedIndex = 0;
        }

    } catch (e) {
        modelSel.innerHTML = `<option value="">Помилка завантаження моделей</option>`;
        console.error("Model loading error:", e);
    }
}

async function sendMessage() {
    if (isLoading) return;
    const input = document.getElementById('userInput');
    const modelSel = document.getElementById('model');
    const msg = (input.value || "").trim();
    if (!msg) return;

    messages.push({ role: "user", content: msg });
    appendMsg("user", msg);
    input.value = "";
    isLoading = true;
    document.getElementById('sendBtn').disabled = true;
    document.getElementById('sessionBtn').disabled = true;
    document.getElementById('noteBtn').disabled = true;

    try {
        const res = await fetch(API_URL, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: modelSel.value || SETTINGS.defaultModel,
                messages: messages,
                temperature: SETTINGS.temperature,
                max_tokens: SETTINGS.maxTokens
            })
        });

        if (!res.ok) {
            const t = await res.text().catch(() => "");
            throw new Error(`HTTP ${res.status}: ${t || res.statusText}`);
        }

        const data = await res.json();
        const reply = data?.choices?.[0]?.message?.content || "Немає відповіді.";
        
        messages.push({ role: "assistant", content: reply });
        const formatted = saferFormatAssistant(reply);
        appendMsg("assistant", formatted, true);

        // Обновляем активную сессию если есть
        if (currentSessionId) {
            const session = appData.sessions.find(s => s.id === currentSessionId);
            if (session) {
                session.messages = [...messages];
                session.messageCount = messages.filter(m => m.role !== 'system').length;
                session.modified = Date.now();
                saveData();
                renderSessions();
            }
        }

        hideControlsAfterFirstMessage();

    } catch (err) {
        appendMsg("assistant", `<span class="muted">Помилка: ${escapeHTML(err.message)}</span>`, true);
    } finally {
        isLoading = false;
        document.getElementById('sendBtn').disabled = false;
        document.getElementById('sessionBtn').disabled = false;
        document.getElementById('noteBtn').disabled = false;
    }
}

// Сохранение как сессии
function saveAsSession() {
    if (messages.filter(m => m.role !== 'system').length === 0) {
        alert('Немає повідомлень для збереження!');
        return;
    }

    const title = prompt('Введіть назву сесії:', 'Нова сесія');
    if (!title || !title.trim()) return;

    const newSession = {
        id: `session_${Date.now()}`,
        title: title.trim(),
        created: Date.now(),
        modified: Date.now(),
        messageCount: messages.filter(m => m.role !== 'system').length,
        messages: [...messages]
    };

    appData.sessions.unshift(newSession);
    currentSessionId = newSession.id;
    appData.selectedItem = newSession.id;
    
    saveData();
    switchTab('sessions');
    renderSessions();
    
    alert('Сесію збережено успішно!');
}

// Создание заметки из последнего сообщения ИИ
function saveAsNote() {
    const lastAIMessage = [...messages].reverse().find(m => m.role === 'assistant');
    if (!lastAIMessage) {
        alert('Немає повідомлень від AI для збереження!');
        return;
    }

    const title = prompt('Введіть назву нотатки:', lastAIMessage.content.substring(0, 50) + '...');
    if (!title || !title.trim()) return;

    const newNote = {
        id: `note_${Date.now()}`,
        type: 'note',
        title: title.trim(),
        content: lastAIMessage.content,
        category: 'study',
        bibleRef: '',
        created: Date.now(),
        sessionId: currentSessionId
    };

    appData.notes.unshift(newNote);
    appData.selectedItem = newNote.id;
    
    saveData();
    switchTab('notes');
    renderNotes();
    
    alert('Нотатку створено успішно!');
}

/* =========================
  THEME MANAGEMENT
  ========================= */
function toggleTheme() {
    const currentTheme = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    applyTheme(currentTheme);
    // В реальной среде здесь бы использовался localStorage
    // localStorage.setItem('theme', currentTheme);
}

function applyTheme(theme) {
    if (theme === 'dark') {
        document.body.setAttribute('data-theme', 'dark');
        document.getElementById('themeBtn').textContent = '☀️ Тема';
    } else {
        document.body.removeAttribute('data-theme');
        document.getElementById('themeBtn').textContent = '🌙 Тема';
    }
}

/* =========================
  CONTROLS MANAGEMENT
  ========================= */
let controlsVisible = true;
let firstMessageSent = false;

function toggleControls() {
    const controls = document.getElementById('controls');
    const toggleBtn = document.getElementById('controlsToggleBtn');
    
    controlsVisible = !controlsVisible;
    
    if (controlsVisible) {
        controls.classList.remove('hidden');
        controls.classList.add('visible');
        toggleBtn.textContent = '⚙️';
        toggleBtn.title = 'Сховати налаштування';
    } else {
        controls.classList.remove('visible');
        controls.classList.add('hidden');
        toggleBtn.textContent = '🔧';
        toggleBtn.title = 'Показати налаштування';
    }
}

function hideControlsAfterFirstMessage() {
    if (!firstMessageSent && controlsVisible) {
        firstMessageSent = true;
        setTimeout(() => {
            toggleControls();
        }, 1000);
    }
}

/* =========================
  IMPORT/EXPORT FUNCTIONS
  ========================= */
function exportData() {
    const dataStr = JSON.stringify(appData, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `bible_assistant_backup_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    URL.revokeObjectURL(url);
    closeModal();
}

function importData() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    appData = { ...appData, ...importedData };
                    saveData();
                    renderCurrentTab();
                    alert('Дані успішно імпортовано!');
                    closeModal();
                } catch (error) {
                    alert('Помилка при імпорті файлу!');
                }
            };
            reader.readAsText(file);
        }
    };
    
    input.click();
}

function clearAll() {
    if (confirm('Видалити всі дані? Цю дію неможливо скасувати!')) {
        appData.sessions = [];
        appData.notes = [];
        appData.selectedItem = null;
        currentSessionId = null;
        clearChatArea();
        showWelcomeMessage();
        saveData();
        renderCurrentTab();
        closeModal();
    }
}

/* =========================
  PUBLIC API
  ========================= */
window.BibleAssistantAPI = {
    // Создать сессию
    createSession: function(title) {
        const session = {
            id: `session_${Date.now()}`,
            title: title || 'Нова сесія',
            created: Date.now(),
            modified: Date.now(),
            messageCount: 0,
            messages: [{ role: "system", content: SETTINGS.systemPrompt }]
        };
        
        appData.sessions.unshift(session);
        saveData();
        
        if (appData.currentTab === 'sessions') {
            renderSessions();
        }
        
        return session.id;
    },
    
    // Создать заметку из сообщения чата
    createNoteFromMessage: function(messageContent, sessionId, title) {
        const note = {
            id: `note_${Date.now()}`,
            type: 'note',
            title: title || messageContent.substring(0, 50) + '...',
            content: messageContent,
            category: 'study',
            bibleRef: '',
            created: Date.now(),
            sessionId: sessionId
        };
        
        appData.notes.unshift(note);
        saveData();
        
        if (appData.currentTab === 'notes') {
            renderNotes();
        }
        
        return note.id;
    },
    
    // Создать закладку
    createBookmark: function(title, sessionId) {
        const bookmark = {
            id: `bookmark_${Date.now()}`,
            type: 'bookmark',
            title: title,
            content: '',
            category: null,
            bibleRef: '',
            created: Date.now(),
            sessionId: sessionId
        };
        
        appData.notes.unshift(bookmark);
        saveData();
        
        if (appData.currentTab === 'notes') {
            renderNotes();
        }
        
        return bookmark.id;
    },
    
    // Обновить счетчик сообщений в сессии
    updateSessionMessageCount: function(sessionId, count) {
        const session = appData.sessions.find(s => s.id === sessionId);
        if (session) {
            session.messageCount = count;
            session.modified = Date.now();
            saveData();
            
            if (appData.currentTab === 'sessions') {
                renderSessions();
            }
        }
    },
    
    // Получить все данные
    getData: function() {
        return appData;
    },
    
    // Поиск в активной вкладке
    search: function(query) {
        document.getElementById('contextSearch').value = query;
        performContextSearch(query);
    },
    
    // Удалить сессию
    deleteSession: function(sessionId) {
        const index = appData.sessions.findIndex(s => s.id === sessionId);
        if (index !== -1) {
            appData.sessions.splice(index, 1);
            // Удаляем связанные заметки
            appData.notes = appData.notes.filter(n => n.sessionId !== sessionId);
            saveData();
            renderCurrentTab();
            return true;
        }
        return false;
    },
    
    // Удалить заметку
    deleteNote: function(noteId) {
        const index = appData.notes.findIndex(n => n.id === noteId);
        if (index !== -1) {
            appData.notes.splice(index, 1);
            saveData();
            if (appData.currentTab === 'notes') {
                renderNotes();
            }
            return true;
        }
        return false;
    },
    
    // Редактировать сессию
    editSession: function(sessionId, newTitle) {
        const session = appData.sessions.find(s => s.id === sessionId);
        if (session) {
            session.title = newTitle;
            session.modified = Date.now();
            saveData();
            if (appData.currentTab === 'sessions') {
                renderSessions();
            }
            return true;
        }
        return false;
    },
    
    // Редактировать заметку
    editNote: function(noteId, updates) {
        const note = appData.notes.find(n => n.id === noteId);
        if (note) {
            Object.assign(note, updates, { modified: Date.now() });
            saveData();
            if (appData.currentTab === 'notes') {
                renderNotes();
            }
            return true;
        }
        return false;
    },
    
    switchToTab: function(tabName) {
        switchTab(tabName);
    },
    
    // Выбрать элемент
    selectItem: function(type, id) {
        if (type === 'session') {
            switchTab('sessions');
            selectSession(id);
        } else if (type === 'note') {
            switchTab('notes');
            selectNote(id);
        }
    }
};

// API для чата
window.BibleChatAPI = {
    updateSettings: function(newSettings) {
        Object.assign(SETTINGS, newSettings);
        if (messages[0]?.role === 'system') {
            messages[0].content = SETTINGS.systemPrompt;
        }
    },
    
    getSettings: () => ({...SETTINGS}),
    setTheme: applyTheme,
    toggleTheme,
    
    sendMessage: function(message) {
        document.getElementById('userInput').value = message;
        sendMessage();
    },
    
    clearChat: function() {
        clearChatArea();
        showWelcomeMessage();
    },
    
    getMessages: () => [...messages],
    
    setMessages: function(newMessages) {
        messages = newMessages;
        loadSessionMessages(newMessages);
    }
};

/* =========================
  EVENT LISTENERS & INITIALIZATION
  ========================= */
document.addEventListener('DOMContentLoaded', async () => {
    // Применяем тему (в реальной среде из localStorage)
    // const savedTheme = localStorage.getItem('theme') || 'light';
    const savedTheme = 'light';
    applyTheme(savedTheme);
    
    // Показываем приветственное сообщение
    showWelcomeMessage();
    
    // Основные кнопки чата
    document.getElementById('sendBtn').addEventListener('click', sendMessage);
    document.getElementById('userInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });
    
    // Кнопки сохранения
    document.getElementById('sessionBtn').addEventListener('click', saveAsSession);
    document.getElementById('noteBtn').addEventListener('click', saveAsNote);
    
    // Кнопки в хедере
    document.getElementById('themeBtn').addEventListener('click', toggleTheme);
    
    // Модальные окна
    document.addEventListener('click', (e) => {
        // Закрываем модалки при клике на backdrop
        if (e.target.classList.contains('modal')) {
            e.target.classList.remove('active');
        }
        
        // Закрываем поиск при клике вне его
        if (!e.target.closest('.search-container')) {
            document.getElementById('searchResults').classList.remove('active');
        }
    });
    
    // Закрытие модалок по Escape
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            // Закрываем все модальные окна
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
            
            // Закрываем поиск
            document.getElementById('searchResults').classList.remove('active');
            document.getElementById('contextSearch').blur();
            // Сбрасываем поиск и показываем все элементы
            document.getElementById('contextSearch').value = '';
            renderCurrentTab();
        }
        
        // Горячие клавиши
        // Ctrl/Cmd + K - фокус на поиск
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            document.getElementById('contextSearch').focus();
        }
        
        // Ctrl/Cmd + N - создать новый элемент
        if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
            e.preventDefault();
            createNew();
        }
        
        // Ctrl/Cmd + Enter - отправить сообщение
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // Управление панелью контролов
    document.getElementById('controlsToggleBtn').addEventListener('click', toggleControls);
    
    // Инициализация данных
    loadData();
    updateSearchPlaceholder();
    renderCurrentTab();
    
    // Загружаем модели AI
    await loadModels();
    
    // Фокус на input
    document.getElementById('userInput').focus();
    
    // Ждем загрузки Bible API
    if (typeof window.bible === 'undefined') {
        console.log('Ожидание загрузки Bible API...');
        const checkBibleAPI = setInterval(() => {
            if (typeof window.bible !== 'undefined') {
                console.log('Bible API загружен успешно!');
                clearInterval(checkBibleAPI);
            }
        }, 500);
    } else {
        console.log('Bible API уже доступен!');
    }
    
    // Автосохранение каждые 30 секунд (в реальной среде с localStorage)
    setInterval(saveData, 30000);
    
    console.log('Біблійний Асистент ініціалізовано');
    console.log('API доступні через window.BibleAssistantAPI та window.BibleChatAPI');
    console.log('Загружено книг:', BOOK_NAMES.length);
    console.log('Индексная карта содержит:', BOOK_INDEX_MAP.size, 'записей');
});

    </script>
</body>
</html>
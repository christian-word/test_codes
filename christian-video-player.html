<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>КИНОПОКАЗ по мотивам Библии</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <meta property="og:image" content="raw.githubusercontent.com/christian-word/GospelVoice/main/ICO/live_films.png">
  <style>
    :root{
      --bg:#0A0E17;
      --surface:#0F1419;
      --surface-light:#1A1F2E;
      --primary:#1E90FF;
      --primary-glow:#1E90FF40;
      --text:#E8F0FE;
      --text2:#8AB4F8;
      --radius:12px;
      --font:'Inter',-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;
    }
    /* Светлая тема */
    body.light{
      --bg:#E3F2FD;
      --surface:#FFFFFF;
      --surface-light:#BBDEFB;
      --primary:#1976D2;
      --primary-glow:#1976D240;
      --text:#0D47A1;
      --text2:#1565C0;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:var(--font);
      background:var(--bg);
      color:var(--text);
      display:flex;
      flex-direction:column;
      align-items:center;
      min-height:100vh;
      padding:24px 16px 60px;
      transition: background 0.5s ease, color 0.5s ease;
    }
    header{
      width:100%;
      max-width:1200px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:24px;
    }
    h1{
      font-size:20px;font-weight:700;
      background: linear-gradient(135deg, var(--primary) 0%, #4169E1 50%, #00BFFF 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    #themeToggleBtn{
      padding:8px 16px;border-radius:8px;
      background:var(--surface);
      border:2px solid var(--primary);color:var(--text);
      font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;
      white-space:nowrap;flex-shrink:0;flex-grow:0;
    }
    #themeToggleBtn:hover{background:var(--surface-light);border-color:#4169E1}

    /* Плеер */
    #player-container{
      width:100%;
      max-width:1200px;
      background:var(--surface);
      border-radius:var(--radius);
      overflow:hidden;
      position:relative;
      box-shadow:0 10px 30px #00000050;
    }
    #player-wrapper{position:relative;width:100%;height:0;padding-bottom:56.25%}
    #player{
      position:absolute;top:0;left:0;width:100%;height:100%;
      background:#000;border:none;outline:none;
    }
    #live-indicator{
      position:absolute;top:12px;left:12px;
      display:none;align-items:center;gap:6px;
      background:#00000060;padding:6px 12px;border-radius:8px;font-size:13px;font-weight:600;
      z-index:10;
      color:#fff;
    }
    #live-indicator span{
      width:8px;height:8px;background:#00BFFF;border-radius:50%;
      animation:pulse 1.2s infinite;
    }
    #intro-logo{
      position:absolute;bottom:20px;right:-200px;
      display:none;align-items:center;gap:8px;
      background:linear-gradient(135deg, rgba(30,144,255,0.85) 0%, rgba(0,191,255,0.85) 100%);
      backdrop-filter:blur(10px);
      padding:8px 16px;border-radius:20px;font-size:14px;font-weight:700;
      z-index:10;
      box-shadow:0 4px 20px rgba(30,144,255,0.7), 0 0 30px rgba(0,191,255,0.4);
      color:#fff;
      letter-spacing:1px;
      transform-style:preserve-3d;
      backface-visibility:hidden;
      border:1px solid rgba(255,255,255,0.3);
    }
    @media (max-width: 768px) {
      #intro-logo {
        padding:6px 12px;
        font-size:11px;
        gap:6px;
        bottom:15px;
      }
      #intro-logo span{
        width:7px;
        height:7px;
      }
    }
    #intro-logo.show{
      animation: logoIntro 7s ease-in-out forwards;
    }
    #intro-logo span{
      width:10px;height:10px;background:#fff;border-radius:50%;
      animation:pulse 1.2s infinite;
    }
    @keyframes pulse{
      0%,100%{transform:scale(1);opacity:1}
      50%{transform:scale(1.4);opacity:.6}
    }
    @keyframes logoIntro{
      0%{right:-200px;opacity:0;transform:rotateY(0deg)}
      20%{right:20px;opacity:1;transform:rotateY(0deg)}
      40%{right:20px;opacity:1;transform:rotateY(360deg)}
      60%{right:20px;opacity:1;transform:rotateY(360deg)}
      80%{right:20px;opacity:1;transform:rotateY(0deg)}
      100%{right:-200px;opacity:0;transform:rotateY(0deg)}
    }

    /* Прогресс-бар */
    #progressBarContainer{height:4px;background:#000;cursor:pointer}
    #progressBar{height:100%;background:var(--primary);width:0;transition:width .1s linear}

    /* Контролы */
    #controls{
      display:flex;flex-wrap:wrap;align-items:center;gap:12px;padding:12px 16px;
      background:var(--surface-light);
    }
    
    /* Мобильная адаптация контролов */
    @media (max-width: 768px) {
      #controls {
        flex-direction: column;
        gap: 8px;
        padding: 10px 12px;
      }
      
      .controls-row {
        display: flex;
        width: 100%;
        gap: 8px;
      }
      
      .controls-row button {
        flex: 1;
        padding: 8px 12px;
        font-size: 13px;
      }
      
      #timezoneSelector {
        width: 100%;
        padding: 8px 12px;
      }
    }
    
    button{
      background:var(--primary);color:#fff;border:none;
      padding:10px 18px;border-radius:var(--radius);
      font-weight:600;cursor:pointer;transition:background .2s;
      flex-grow:1;
    }
    button:hover{background:#4169E1}
    button:disabled{background:#555;cursor:not-allowed;opacity:0.5}
    select{
      background:var(--surface);color:var(--text);
      border:1px solid #444;padding:10px 14px;border-radius:var(--radius);
      font-size:14px;cursor:pointer;
      flex-grow:1;
    }
    body.light select{
        border:1px solid #ddd;
    }

    /* Статус + время */
    #status, #localTimeStatus, #realTimeStatus{
      font-size:13px;color:var(--text2);
      margin-top:6px;text-align:center;
    }

    /* Расписание */
    #programScheduleDisplay{
      width:100%;max-width:1200px;margin-top:32px;
    }
    #programScheduleDisplay h2{font-size:18px;margin-bottom:12px}
    #scheduleList{list-style:none;display:grid;gap:10px}
    .schedule-item{
      background:var(--surface);padding:14px 18px;border-radius:var(--radius);
      display:flex;justify-content:space-between;align-items:center;
      border:1px solid transparent;transition:border .2s;
    }
    .schedule-item.current{
      border-color:var(--primary);
      box-shadow: 0 0 0 4px var(--primary-glow);
    }
    .schedule-item-left{
        display: flex;
        flex-direction: column;
        gap: 2px;
        flex-grow: 1;
    }
    .schedule-item-right{
        text-align: right;
        flex-shrink: 0;
        margin-left: 10px;
    }
    .schedule-item strong{font-weight:600}
    .schedule-item small{color:var(--text2)}

    /* Полноэкран */
    #exitFullscreenBtn{
      position:absolute;top:12px;right:12px;z-index:9999;
      width:36px;height:36px;border-radius:50%;
      background:#00000060;color:#fff;border:none;font-size:18px;
      cursor:pointer;opacity:0;pointer-events:none;transition:opacity .3s;
      box-shadow:0 2px 8px rgba(0,0,0,0.3);
    }
    .virtual-fullscreen #exitFullscreenBtn{opacity:0.7;pointer-events:auto}
    .virtual-fullscreen #exitFullscreenBtn:hover{opacity:1;background:#00000090}
    .virtual-fullscreen #player-container{
      position:fixed;top:50%;left:50%;
      transform:translate(-50%,-50%) rotate(90deg);
      width:100vh;height:100vw;max-width:none;z-index:9999;
    }
    .virtual-fullscreen #controls,
    .virtual-fullscreen header,
    .virtual-fullscreen #programScheduleDisplay{display:none}
    
    #fullscreenToggleBtn {
        display: inline-block;
    }
    @media (max-width: 768px) {
        body {
            padding: 16px 12px 60px;
        }
    }
  </style>
</head>
<body>
  <header>
    <h1>Христианский Кинозал</h1>
    <button id="themeToggleBtn" title="Сменить тему">Тема</button>
  </header>

  <div id="player-container">
    <div id="player-wrapper">
      <video id="player" preload="metadata"></video>
      <button id="exitFullscreenBtn">✕</button>
      <div id="live-indicator"><span></span>LIVE Films</div>
      <div id="intro-logo"><span></span>LIVE Films</div>
    </div>
    <div id="progressBarContainer"><div id="progressBar"></div></div>

    <div id="controls">
      <div class="controls-row">
        <button id="playButton" disabled>▶ Смотреть</button>
        <button id="fullscreenToggleBtn" disabled>⛶ Полный экран</button>
      </div>
<select id="timezoneSelector" disabled>
  <option value="0" selected>⏰ Текущее время</option>
  <option value="3600">⏩ +1 час</option>
  <option value="7200">⏩ +2 часа</option>
  <option value="10800">⏩ +3 часа</option>
  <option value="-3600">⏪ -1 час</option>
  <option value="-7200">⏪ -2 часа</option>
  <option value="-10800">⏪ -3 часа</option>
</select>
    </div>
  </div>

  <div id="status">Статус: Загрузка расписания...</div>
  <div id="localTimeStatus">Местное время трансляции: --:--</div>
  <div id="realTimeStatus">Текущее время: --:--</div>

  <div id="programScheduleDisplay">
    <h2>📋 Расписание трансляции</h2>
    <ul id="scheduleList"></ul>
  </div>

  <script>
    /* ---------- 1. Тема ---------- */
    const themeBtn=document.getElementById('themeToggleBtn');
    themeBtn.addEventListener('click',()=>{
      document.body.classList.toggle('light');
      const theme = document.body.classList.contains('light') ? 'light' : 'dark';
    });

    /* ---------- 2. Видеоплеер ---------- */
    let player=document.getElementById('player'),
        playButton=document.getElementById('playButton'),
        timezoneSelector=document.getElementById('timezoneSelector'),
        fullscreenToggleBtn=document.getElementById('fullscreenToggleBtn'),
        exitFullscreenBtn=document.getElementById('exitFullscreenBtn'),
        statusDiv=document.getElementById('status'),
        localTimeStatusDiv=document.getElementById('localTimeStatus'),
        realTimeStatusDiv=document.getElementById('realTimeStatus'),
        progressBar=document.getElementById('progressBar'),
        scheduleList=document.getElementById('scheduleList'),
        liveIndicator=document.getElementById('live-indicator'),
        introLogo=document.getElementById('intro-logo');
    let currentVideoIndex=0,syncTimer=null,progressTimer=null;

    /* ---------- 3. Плейлист ---------- */
    const PLAYLIST_URL='https://dl.dropboxusercontent.com/scl/fi/q4ip5ly8jzueivnbvx3z5/playFilms.json?rlkey=qv1opk3a7b4acg0mzbx4m71ae&st=gvif10ty&dl=1';
    let broadcastProgram=null;
    
    async function fetchPlaylist(){
      try{
        const r=await fetch(PLAYLIST_URL);
        if(!r.ok) throw new Error('Не удалось загрузить плейлист');
        const data=await r.json();
        let t=0;
        data.programSchedule.forEach(v=>{v.startTime=t;t+=v.duration;});
        broadcastProgram=data;
        statusDiv.textContent='Плеер готов. Выберите поправку и нажмите Play.';
        playButton.disabled=false;
        timezoneSelector.disabled=false;
        fullscreenToggleBtn.disabled=false;
        renderSchedule();
      }catch(e){
        statusDiv.textContent='Ошибка: '+e.message;
      }
    }

    /* ---------- 4. Трансляция ---------- */
    function startBroadcast(){
      if(!broadcastProgram) return;
      if(syncTimer) clearInterval(syncTimer);
      if(progressTimer) clearInterval(progressTimer);
      statusDiv.textContent='Синхронизируем и запускаем...';
      
      // Запускаем интро-анимацию логотипа (для показа загрузки)
      introLogo.style.display='flex';
      introLogo.classList.add('show');
      
      // Убираем анимационный логотип после показа (7 секунд)
      setTimeout(() => {
        introLogo.classList.remove('show');
        introLogo.style.display='none';
      }, 7000);
      
      // Показываем постоянный LIVE индикатор
      liveIndicator.style.display='flex';
      
      const offset=parseInt(timezoneSelector.value,10);
      const real=Date.now()/1000;
      const start=new Date(broadcastProgram.broadcastStartTime).getTime()/1000;
      let elapsed=real-start+offset;
      let vid=null,sec=0,idx=0;
      
      if(elapsed<0){
        vid=broadcastProgram.programSchedule[0];
        sec=0;
        idx=0;
      }else{
        for(let i=0;i<broadcastProgram.programSchedule.length;i++){
          const v=broadcastProgram.programSchedule[i];
          if(elapsed>=v.startTime&&elapsed<v.startTime+v.duration){
            vid=v;
            sec=elapsed-v.startTime;
            idx=i;
            break;
          }
        }
      }
      
      if(vid){
        player.src = vid.url + `#t=${Math.max(0, sec)}`;
        player.play().catch(e=>statusDiv.textContent='Ошибка воспроизведения: '+e.message);
        currentVideoIndex=idx;
        startSyncTimer(start);
        highlightCurrentVideo(currentVideoIndex);
        startProgressTimer();
      }else{
        statusDiv.textContent='Плейлист закончился';
        liveIndicator.style.display='none';
      }
    }

    player.addEventListener('ended', ()=>{
      currentVideoIndex++;
      if(currentVideoIndex<broadcastProgram.programSchedule.length){
        const v=broadcastProgram.programSchedule[currentVideoIndex];
        player.src = v.url;
        player.play();
        highlightCurrentVideo(currentVideoIndex);
      }else{
        statusDiv.textContent='Плейлист закончился';
        liveIndicator.style.display='none';
        if(syncTimer) clearInterval(syncTimer);
        if(progressTimer) clearInterval(progressTimer);
      }
    });

    player.addEventListener('playing', ()=>{
      liveIndicator.style.display='flex';
    });

    player.addEventListener('pause', ()=>{
      if(!player.ended) liveIndicator.style.display='none';
    });

    /* ---------- 5. Синхронизация ---------- */
    function startSyncTimer(broadcastStartTimeInSeconds){
      syncTimer=setInterval(()=>{
        if(player.paused || player.ended) return;
        
        const now=Date.now()/1000;
        const offset=parseInt(timezoneSelector.value,10);
        const elapsedTime = now - broadcastStartTimeInSeconds + offset;
        
        const display=new Date((broadcastStartTimeInSeconds + elapsedTime) * 1000);
        localTimeStatusDiv.textContent=`Местное время трансляции: ${display.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit',second:'2-digit'})}`;
        
        let idx=-1,sec=0;
        if(elapsedTime<0){
          idx=0;sec=0;
        }else{
          for(let i=0;i<broadcastProgram.programSchedule.length;i++){
            const v=broadcastProgram.programSchedule[i];
            if(elapsedTime>=v.startTime&&elapsedTime<v.startTime+v.duration){
              idx=i;
              sec=elapsedTime-v.startTime;
              break;
            }
          }
        }
        
        if(idx===-1){
          clearInterval(syncTimer);
          statusDiv.textContent='Трансляция закончилась';
          liveIndicator.style.display='none';
          return;
        }
        
        if(idx!==currentVideoIndex){
          currentVideoIndex=idx;
          player.src = broadcastProgram.programSchedule[currentVideoIndex].url + `#t=${Math.max(0, sec)}`;
          player.play();
          statusDiv.textContent=`Смена видео на #${currentVideoIndex+1}`;
          highlightCurrentVideo(currentVideoIndex);
          return;
        }
        
        const drift=player.currentTime-sec;
        if(Math.abs(drift)>1){
          player.playbackRate=drift>0?.9:1.1;
          statusDiv.textContent=`Корректировка скорости. Разница: ${drift.toFixed(2)}с`;
        }else{
          player.playbackRate=1;
          statusDiv.textContent='Синхронизировано';
        }
      },1000);
    }

    function startProgressTimer(){
      if(progressTimer) clearInterval(progressTimer);
      progressTimer=setInterval(()=>{
        if(player&&player.duration){
          const cur=player.currentTime,dur=player.duration;
          if(dur>0) progressBar.style.width=(cur/dur*100)+'%';
        }
      },500);
    }

    /* ---------- 6. Расписание ---------- */
    function parseVideoInfo(title, index) {
      if (!title) {
        return {
          shortTitle: `Видео №${index + 1}`,
          speakerAndDate: ''
        };
      }
      
      const parts = title.split(', ');
      let speakerAndDate = '';
      let shortTitle = '';

      if (parts.length >= 2) {
        const date = parts.pop();
        const speaker = parts.pop();
        speakerAndDate = `${speaker}, ${date}`;
        shortTitle = parts.join(', ');
      } else {
        shortTitle = title;
      }

      if (shortTitle.length > 50) {
        shortTitle = shortTitle.substring(0, 50) + '...';
      }

      return { shortTitle, speakerAndDate };
    }
    
    function renderSchedule(){
      if(!broadcastProgram) return;
      scheduleList.innerHTML='';
      const start=new Date(broadcastProgram.broadcastStartTime).getTime()/1000;
      broadcastProgram.programSchedule.forEach((v,i)=>{
        const li=document.createElement('li');
        li.className='schedule-item';
        li.dataset.index=i;
        const videoStartTime = new Date((start + v.startTime) * 1000);
        const videoEndTime = new Date((start + v.startTime + v.duration) * 1000);
        const { shortTitle, speakerAndDate } = parseVideoInfo(v.title, i);

        const durationMinutes = Math.floor(v.duration / 60);
        const durationSeconds = v.duration % 60;
        const durationFormatted = `${durationMinutes} мин ${durationSeconds} сек`;

        li.innerHTML=`
          <div class="schedule-item-left">
            <strong>${shortTitle}</strong>
            <small>${speakerAndDate}</small>
            <small>Длительность: ${durationFormatted}</small>
          </div>
          <div class="schedule-item-right">
            <small>
                ${videoStartTime.getHours().toString().padStart(2, '0')}:${videoStartTime.getMinutes().toString().padStart(2, '0')} – 
                ${videoEndTime.getHours().toString().padStart(2, '0')}:${videoEndTime.getMinutes().toString().padStart(2, '0')}
            </small>
          </div>
        `;
        scheduleList.appendChild(li);
      });
    }

    function highlightCurrentVideo(index){
      document.querySelectorAll('.schedule-item').forEach(item=>item.classList.remove('current'));
      const cur=document.querySelector(`.schedule-item[data-index="${index}"]`);
      if(cur) cur.classList.add('current');
    }

    /* ---------- 7. Полноэкран ---------- */
    function isMobile() {
      return window.innerWidth <= 768;
    }
    
    fullscreenToggleBtn.addEventListener('click',()=>{
      if(isMobile()) {
        document.body.classList.add('virtual-fullscreen');
      } else {
        const container = document.getElementById('player-container');
        if(container.requestFullscreen) {
          container.requestFullscreen();
        } else if(container.webkitRequestFullscreen) {
          container.webkitRequestFullscreen();
        } else if(container.mozRequestFullScreen) {
          container.mozRequestFullScreen();
        } else if(container.msRequestFullscreen) {
          container.msRequestFullscreen();
        }
      }
    });
    
    exitFullscreenBtn.addEventListener('click',()=>{
      document.body.classList.remove('virtual-fullscreen');
    });
    
    document.addEventListener('fullscreenchange', ()=>{
      if(!document.fullscreenElement) {
        // Вышли из полноэкранного режима
      }
    });
    document.addEventListener('webkitfullscreenchange', ()=>{
      if(!document.webkitFullscreenElement) {
        // Вышли из полноэкранного режима
      }
    });

    /* ---------- 8. Часы ---------- */
    setInterval(()=>realTimeStatusDiv.textContent='Текущее время: '+new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit',second:'2-digit'}),1000);

    /* ---------- 9. Инициализация ---------- */
    fetchPlaylist();
    playButton.addEventListener('click', startBroadcast);
    timezoneSelector.addEventListener('change', startBroadcast);
  </script>
</body>
</html>
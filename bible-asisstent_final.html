<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Біблійний Асистент - Повна версія</title>
    <script src="https://christian-word.github.io/bible-engine/bible-API.js"></script>
    <style>
        :root {
            --primary: #1a73e8;
            --bg: #f8f9fa;
            --card: #ffffff;
            --text: #202124;
            --muted: #5f6368;
            --border: #dadce0;
            --hover: #f1f3f4;
            --success: #34a853;
            --danger: #ea4335;
            --accent: #ffcc00;
        }

        [data-theme="dark"] {
            --bg: #1a1a1a;
            --card: #2d2d2d;
            --text: #ffffff;
            --muted: #aaaaaa;
            --border: #444;
            --hover: #383838;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Боковая панель */
        .sidebar {
            width: 320px;
            background: var(--card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .sidebar.collapsed {
            transform: translateX(-280px);
            width: 40px;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .collapse-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }

        .collapse-btn:hover {
            background: var(--hover);
        }

        /* Строка поиска */
        .search-container {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .search-box {
            position: relative;
            width: 100%;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 40px;
            border: 1px solid var(--border);
            border-radius: 24px;
            font-size: 14px;
            outline: none;
            background: var(--hover);
            transition: all 0.2s;
        }

        .search-input:focus {
            background: white;
            border-color: var(--primary);
            box-shadow: 0 2px 5px 1px rgba(64,60,67,.16);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--muted);
            font-size: 16px;
        }

        /* Табы */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
        }

        .tab {
            flex: 1;
            background: none;
            border: none;
            padding: 12px 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: var(--muted);
            position: relative;
        }

        .tab.active {
            color: var(--primary);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
        }

        /* Содержимое табов */
        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .panel {
            display: none;
        }

        .panel.active {
            display: block;
        }

        /* Элементы списков */
        .list-item {
            padding: 12px;
            margin-bottom: 4px;
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .list-item:hover {
            border-color: var(--primary);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .list-item.selected {
            border-color: var(--primary);
            background: rgba(26, 115, 232, 0.04);
        }

        .item-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .list-item:hover .item-actions {
            opacity: 1;
        }

        .action-btn {
            background: var(--hover);
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: var(--border);
            transform: scale(1.1);
        }

        .action-btn.edit {
            color: var(--primary);
        }

        .action-btn.delete {
            color: var(--danger);
        }

        .action-btn.delete:hover {
            background: var(--danger);
            color: white;
        }

        .item-title {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .item-meta {
            font-size: 12px;
            color: var(--muted);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-category {
            background: var(--primary);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 500;
        }

        .category-study { background: #34a853; }
        .category-prayer { background: #9c27b0; }
        .category-sermon { background: #ff9800; }
        .category-personal { background: #e91e63; }

        /* Основная область - чат */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .menu-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 16px;
            display: none;
            z-index: 100;
        }

        .main-content.sidebar-collapsed .menu-toggle {
            display: block;
        }

        /* Заголовок чата */
        .chat-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            background: var(--card);
        }

        .chat-title-section {
            flex: 1;
            min-width: 0;
        }

        .chat-title {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
        }

        .chat-subtitle {
            font-size: 11px;
            color: var(--muted);
            margin-top: 2px;
        }

        /* Панель управления чатом */
        .chat-controls {
            padding: 12px 16px;
            background: var(--card);
            border-bottom: 1px solid var(--border);
            display: grid;
            grid-template-columns: 1fr 120px 80px;
            gap: 8px;
            align-items: center;
            transition: all 0.3s ease;
        }

        .chat-controls.hidden {
            max-height: 0;
            padding: 0 16px;
            opacity: 0;
            border-bottom: none;
            overflow: hidden;
        }

        .model-select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg);
        }

        .control-btn {
            padding: 8px 12px;
            border: 0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            background: var(--hover);
            font-size: 12px;
        }

        .controls-toggle-btn {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 8px;
            color: var(--text);
            border-radius: 6px;
            transition: all 0.2s ease;
            margin-left: 8px;
        }

        .controls-toggle-btn:hover {
            background: var(--hover);
        }

        /* Область чата */
        .chat-area {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            background: var(--bg);
        }

        .message {
            margin: 8px 0 16px;
            line-height: 1.5;
            display: flex;
            align-items: flex-start;
            gap: 8px;
            position: relative;
        }

        .message-role {
            font-weight: 700;
            min-width: 25px;
        }

        .message.ai .message-role {
            color: var(--primary);
        }

        .message.user .message-role {
            color: var(--success);
        }

        .message-text {
            flex: 1;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* Метка для создания заметок */
        .message-marker {
            position: absolute;
            right: 8px;
            top: 0;
            width: 24px;
            height: 24px;
            background: var(--accent);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.2s;
            color: #000;
            z-index: 10;
        }

        .message.ai:hover .message-marker {
            opacity: 1;
        }

        .message-marker:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .message.ai {
            padding-right: 40px;
        }

        /* Область ввода */
        .input-area {
            padding: 16px;
            background: var(--card);
            border-top: 1px solid var(--border);
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
        }

        .user-input {
            padding: 12px;
            font-size: 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg);
            color: var(--text);
        }

        .send-btn {
            padding: 10px 16px;
            border: 0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            background: var(--success);
            color: #fff;
        }

        .send-btn:disabled {
            opacity: .6;
            cursor: not-allowed;
        }

        /* Кнопки действий */
        .action-buttons {
            padding: 16px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
        }

        .btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-secondary {
            background: var(--hover);
            color: var(--text);
        }

        .btn:hover {
            opacity: 0.9;
        }

        /* Пустое состояние */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--muted);
        }

        .empty-state h3 {
            margin: 0 0 8px;
            font-size: 16px;
            font-weight: 500;
            color: var(--text);
        }

        .empty-state p {
            margin: 0;
            font-size: 14px;
        }

        /* Модальные окна */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card);
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            color: var(--text);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 6px;
            font-size: 14px;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            background: var(--bg);
            color: var(--text);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        /* Библейские ссылки */
        .bible-ref {
            color: var(--primary);
            text-decoration: underline;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .bible-ref:hover {
            background-color: rgba(26, 115, 232, 0.1);
            border-radius: 3px;
        }

.search-results {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-top: 8px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .search-results.active {
            display: block;
        }

        .search-result {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .search-result:hover {
            background: var(--hover);
        }

        .search-result:last-child {
            border-bottom: none;
        }

        .result-type {
            font-size: 11px;
            color: var(--muted);
            text-transform: uppercase;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .result-title {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 2px;
            line-height: 1.3;
        }

        .result-preview {
            font-size: 12px;
            color: var(--muted);
            line-height: 1.3;
            margin-top: 4px;
        }

        .result-meta {
            font-size: 11px;
            color: var(--muted);
            margin-top: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Подсветка поиска */
        mark {
            background: rgba(255, 204, 0, 0.4);
            color: inherit;
            padding: 1px 2px;
            border-radius: 2px;
            font-weight: 500;
        }



        /* Адаптивность */
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                left: 0;
                top: 0;
                height: 100%;
                z-index: 1000;
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content .menu-toggle {
                display: block;
            }

            .overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 999;
                display: none;
            }

            .overlay.active {
                display: block;
            }

            .chat-controls {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .input-area {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .send-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Боковая панель -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2 class="sidebar-title">📖 Біблія Асистент</h2>
                <button class="collapse-btn" onclick="toggleSidebar()">‹</button>
            </div>

            <!-- Поиск -->
            <div class="search-container">
                <div class="search-box">
                    <div class="search-icon">🔍</div>
                    <input type="text" 
                           class="search-input" 
                           id="contextSearch"
                           oninput="performContextSearch(this.value)"
                           placeholder="Пошук у сесіях та нотатках...">
                </div>
                <div class="search-results" id="searchResults"></div>
            </div>

            <!-- Табы -->
            <div class="tabs">
                <button class="tab active" data-tab="sessions" onclick="switchTab('sessions')">
                    📝 Сесії
                </button>
                <button class="tab" data-tab="notes" onclick="switchTab('notes')">
                    🔖 Нотатки
                </button>
            </div>

            <!-- Содержимое -->
            <div class="tab-content">
                <!-- Панель сессий -->
                <div class="panel active" id="sessions-panel">
                    <div id="sessions-list"></div>
                    <div class="empty-state" id="sessions-empty" style="display: none;">
                        <h3>Немає сесій</h3>
                        <p>Створіть нову сесію для початку роботи</p>
                    </div>
                </div>

                <!-- Панель заметок -->
                <div class="panel" id="notes-panel">
                    <div id="notes-list"></div>
                    <div class="empty-state" id="notes-empty" style="display: none;">
                        <h3>Немає нотаток</h3>
                        <p>Створіть нотатку або закладку</p>
                    </div>
                </div>
            </div>

            <!-- Кнопки действий -->
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="createNew()">
                    ➕ Створити
                </button>
                <button class="btn btn-secondary" onclick="showOptions()">
                    📁 Файл
                </button>
            </div>
        </div>

        <!-- Основная область - чат -->
        <div class="main-content" id="mainContent">
            <button class="menu-toggle" onclick="toggleSidebar()">☰</button>
            
            <!-- Заголовок чата -->
            <div class="chat-header">
                <div class="chat-title-section">
                    <h1 class="chat-title" id="chatTitle">Біблійний чат</h1>
                    <div class="chat-subtitle">ЄХБ м.Суми, Україна</div>
                </div>
                <button class="controls-toggle-btn" onclick="toggleChatControls()" title="Показати налаштування">⚙️</button>
            </div>

            <!-- Панель управления чатом -->
            <div class="chat-controls" id="chatControls">
                <select class="model-select" id="model" title="Модель AI"></select>
                <button class="control-btn" onclick="showHelp()">🆘 Допомога</button>
                <button class="control-btn" id="themeBtn" onclick="toggleTheme()">🌙 Тема</button>
            </div>

            <!-- Область чата -->
            <div class="chat-area" id="chatArea">
                <div class="empty-state">
                    <h3>Вітаємо у Біблійному Асистенті!</h3>
                    <p>Почніть нову розмову або виберіть існуючу сесію з бокової панелі.</p>
                </div>
            </div>

            <!-- Область ввода -->
            <div class="input-area">
                <input class="user-input" 
                       id="userInput" 
                       type="text" 
                       placeholder="Напишіть запитання про Біблію..."
                       onkeypress="handleInputKeypress(event)">
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">Надіслати</button>
            </div>
        </div>
    </div>

    <!-- Оверлей для мобильных -->
    <div class="overlay" id="overlay" onclick="closeSidebar()"></div>

    <!-- Модальные окна -->
    <!-- Создание новых элементов -->
    <div class="modal" id="createModal">
        <div class="modal-content">
            <h3>Створити нову</h3>
            <div class="form-group">
                <label class="form-label">Тип:</label>
                <select class="form-select" id="createType" onchange="toggleCreateFields()">
                    <option value="session">📝 Нова сесія</option>
                    <option value="note">📖 Нотатка</option>
                    <option value="bookmark">🔖 Закладка</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Назва:</label>
                <input type="text" class="form-input" id="createTitle" placeholder="Введіть назву...">
            </div>

            <div id="noteFields" style="display: none;">
                <div class="form-group">
                    <label class="form-label">Категорія:</label>
                    <select class="form-select" id="createCategory">
                        <option value="study">📖 Вивчення</option>
                        <option value="prayer">🙏 Молитва</option>
                        <option value="sermon">🎤 Проповідь</option>
                        <option value="personal">💭 Особисте</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Біблійна посилання:</label>
                    <input type="text" class="form-input" id="createReference" placeholder="напр: Пс. 23:1-6">
                </div>

                <div class="form-group">
                    <label class="form-label">Зміст:</label>
                    <textarea class="form-textarea" id="createContent" placeholder="Введіть текст..."></textarea>
                </div>
            </div>

            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Скасувати</button>
                <button class="btn btn-primary" onclick="createItem()">Створити</button>
            </div>
        </div>
    </div>

    <!-- Создание заметки к сообщению -->
    <div class="modal" id="messageNoteModal">
        <div class="modal-content">
            <h3>Створити нотатку до повідомлення</h3>
            <div class="form-group">
                <label class="form-label">Тип:</label>
                <select class="form-select" id="messageNoteType" onchange="toggleMessageNoteFields()">
                    <option value="bookmark">🔖 Закладка</option>
                    <option value="note">📖 Нотатка</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Назва:</label>
                <input type="text" class="form-input" id="messageNoteTitle" placeholder="Введіть назву...">
            </div>

            <div id="messageNoteFields" style="display: none;">
                <div class="form-group">
                    <label class="form-label">Категорія:</label>
                    <select class="form-select" id="messageNoteCategory">
                        <option value="study">📖 Вивчення</option>
                        <option value="prayer">🙏 Молитва</option>
                        <option value="sermon">🎤 Проповідь</option>
                        <option value="personal">💭 Особисте</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Біблійна посилання:</label>
                    <input type="text" class="form-input" id="messageNoteReference" placeholder="напр: Пс. 23:1-6">
                </div>

                <div class="form-group">
                    <label class="form-label">Зміст:</label>
                    <textarea class="form-textarea" id="messageNoteContent" placeholder="Введіть текст..."></textarea>
                </div>
            </div>

            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Скасувати</button>
                <button class="btn btn-primary" onclick="createMessageNote()">Створити</button>
            </div>
        </div>
    </div>

    <!-- Опции -->
    <div class="modal" id="optionsModal">
        <div class="modal-content">
            <h3>Опції</h3>
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <button class="btn btn-secondary" onclick="exportData()">📤 Експорт даних</button>
                <button class="btn btn-secondary" onclick="importData()">📥 Імпорт даних</button>
                <button class="btn btn-danger" onclick="clearAll()">🗑️ Очистити все</button>
                <button class="btn btn-primary" onclick="closeModal()">Закрити</button>
            </div>
        </div>
    </div>

    <!-- Модалка с библейскими стихами -->
    <div class="modal" id="verseModal">
    </div>

    <!-- Модалка помощи -->
    <div class="modal" id="helpModal">
        <div class="modal-content">
            <h2>📚 Допомога</h2>
            <div style="line-height: 1.6; font-size: 14px;">
                <h3>📖 Біблійні посилання</h3>
                <p>• Клікніть на будь-яке посилання на Біблію щоб побачити текст</p>
                <p>• Підтримуються формати: (Пс. 23:1), (Буття 1:1-3), (Ів. 3:16)</p>
                <p>• Можна переглядати всю главу цілком</p>
                
                <h3>🔖 Нотатки та закладки</h3>
                <p>• Після кожного відповіді ІІ з'являється жовта метка</p>
                <p>• Клікніть на метку щоб створити нотатку або закладку</p>
                <p>• Нотатки прив'язуються до конкретного повідомлення</p>
                
                <h3>💡 Приклади питань</h3>
                <p>• "Надрукуй Псалом 23 повністю"</p>
                <p>• "Поясни притчу про блудного сина"</p>
                <p>• "Порівняй Івана 3:16 у різних перекладах"</p>
            </div>
            <div class="form-actions">
                <button class="btn btn-primary" onclick="closeModal()">Зрозуміло!</button>
            </div>
        </div>
    </div>

 <script>
// Конфигурация API
const encrypted = "Z3NrX1NUelQyS1FFQko3MGNDb1hDSllaV0dkeWIzRlk5OHJHN2xvWXUxSmc1SnV0VFZOSzIyVHY=";
const apiKey = atob(encrypted);
const API_BASE = "https://api.groq.com/openai/v1";
const API_URL = `${API_BASE}/chat/completions`;
const MODELS_URL = `${API_BASE}/models`;

// Системный промпт
const BOOK_NAMES = [
    ["Буття", "Бут."], ["Вихід", "Вих."], ["Левіт", "Лев."], ["Числа", "Чис."], ["Второзаконня", "Втор."],
    ["Ісуса Навина", "Нав.", "Ісус Навин"], ["Суддів", "Суд.", "Судді"], ["Рути", "Рут.", "Рут"],
    ["1 Самуїлова", "1 Сам.", "1Сам."], ["2 Самуїлова", "2 Сам.", "2Сам."], ["1 Царів", "1 Цар.", "1Цар."],
    ["2 Царів", "2 Цар.", "2Цар."], ["1 Хронік", "1 Хр.", "1Хр."], ["2 Хронік", "2 Хр.", "2Хр."],
    ["Ездри", "Езд.", "Ездра", "Ездр."], ["Неємії", "Неєм.", "Неемія", "Неем."], ["Есфирі", "Есф.", "Естер", "Ест."],
    ["Йова", "Йов."], ["Псалми", "Пс.", "Псалом"], ["Приповісті Соломонові", "Прип.", "Приповісті", "Пр."],
    ["Екклезіаст", "Еккл.", "Екклезіяст", "Екл."], ["Пісня Соломона", "Піс.", "Пісня над піснями", "Пісн."],
    ["Ісаї", "Іс.", "Ісая"], ["Єремії", "Єр."], ["Плач Єремії", "Плач", "Пл.Єр."], ["Єзекиїла", "Єз.", "Єзекіїль"],
    ["Даниїла", "Дан.", "Даниїл"], ["Осії", "Ос.", "Осія"], ["Йоіла", "Йоіл.", "Йоіл"], ["Амоса", "Ам.", "Амос"],
    ["Авдія", "Авд.", "Овдій", "Овд."], ["Йони", "Йона", "Йон."], ["Михея", "Мих.", "Михей"], ["Наума", "Наум"],
    ["Авакума", "Ав.", "Авакум"], ["Софонії", "Соф.", "Софонія"], ["Аггея", "Агг.", "Огій", "Ог."],
    ["Захарії", "Зах.", "Захарія"], ["Малахії", "Мал.", "Малахія"], ["Матвія", "Матв.", "Мт."],
    ["Марка", "Марк.", "Мр."], ["Луки", "Лук.", "Лк."], ["Івана", "Ів."], ["Дії апостолів", "Дії", "Дії Апостолів"],
    ["Римлян", "Рим."], ["1 Коринтян", "1 Кор.", "1Кор."], ["2 Коринтян", "2 Кор.", "2Кор."], ["Галатів", "Гал."],
    ["Ефесян", "Еф."], ["Филипян", "Фил.", "Филип'ян"], ["Колоссян", "Кол.", "Колосян"], ["1 Солунян", "1 Сол.", "1Сол."],
    ["2 Солунян", "2 Сол.", "2Сол."], ["1 Тимофія", "1 Тим.", "1Тим."], ["2 Тимофія", "2 Тим.", "2Тим."],
    ["Тита", "Тит"], ["Филимона", "Филм.", "Флм."], ["Євреїв", "Євр."], ["Якова", "Як."], ["1 Петра", "1 Пет.", "1Пет."],
    ["2 Петра", "2 Пет.", "2Пет."], ["1 Івана", "1 Ів.", "1Ів."], ["2 Івана", "2 Ів.", "2Ів."],
    ["3 Івана", "3 Ів.", "3Ів."], ["Юди", "Юд."], ["Об'явлення Івана Богослова", "Об'явл."]
];

const BOOK_INDEX_MAP = new Map();
BOOK_NAMES.forEach((bookVariants, index) => {
    bookVariants.forEach(variant => {
        BOOK_INDEX_MAP.set(variant, index + 1);
        BOOK_INDEX_MAP.set(variant.replace(/\.$/, ""), index + 1);
    });
});

const BOOKS_LIST_FOR_PROMPT = BOOK_NAMES.map(variants => variants.join(", ")).join("; ");

const DEFAULT_PROMPT = `Ти — асистент-богослов і знавець Біблії. Відповідай стисло, точно і з повагою.

ВАЖЛИВО! При згадуванні біблійних книг використовуй ТІЛЬКИ ці назви:
${BOOKS_LIST_FOR_PROMPT}

Дотримуйся цих правил:
- Завжди тримайся біблійної теми, уникай оффтопу.
- Якщо наводиш цитати, вказуй книгу, розділ і вірші у форматі (Книга число:число).
- За можливості пояснюй контекст (хто говорить, кому, у якій ситуації).
- Використовуй переклад Огієнка як основний при цитуванні.
- При згадуванні біблійних джерел ЗАВЖДИ використовуй формат (Книга число:число) у круглих дужках.
- Коли доречно, додавай порівняння з іншими українськими перекладами і коротко коментуй різницю.
- Коротко додавай богословські коментарі, чітко відділяючи їх від тексту Писання.
- Відповідай українською мовою.
- Подавай цитати з номерами віршів і завжди вказуй джерело у круглих дужках після цитати.
- НЕ вигадуй інших назв книг, крім зазначених вище!`;

// Глобальные переменные
let appData = {
    sessions: {},
    notes: {},
    currentSessionId: null,
    messageCounter: 0
};

let isLoading = false;
let chatControlsVisible = true;
let activeTab = 'sessions';
let currentMessageForNote = null;

// Утилиты
function generateId() {
    return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

function formatDate(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diffMs = now - date;
    const diffHours = diffMs / (1000 * 60 * 60);
    
    if (diffHours < 1) {
        const diffMins = Math.floor(diffMs / (1000 * 60));
        return diffMins <= 1 ? 'щойно' : `${diffMins} хв тому`;
    } else if (diffHours < 24) {
        return `${Math.floor(diffHours)} год тому`;
    } else if (diffHours < 48) {
        return 'вчора';
    } else {
        return date.toLocaleDateString('uk-UA');
    }
}

function escapeHTML(str) {
    return (str ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
}

function linkify(htmlEscaped) {
    return htmlEscaped.replace(/(https?:\/\/[^\s)<>"]+)/g, '<a class="inline" href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
}

// Функция поиска номера книги
function getBookNumber(bookName) {
    if (!bookName) return null;
    
    const normalized = bookName.trim();
    
    if (BOOK_INDEX_MAP.has(normalized)) {
        return BOOK_INDEX_MAP.get(normalized);
    }
    
    const withoutDot = normalized.replace(/\.$/, "");
    if (BOOK_INDEX_MAP.has(withoutDot)) {
        return BOOK_INDEX_MAP.get(withoutDot);
    }
    
    const lowerNormalized = normalized.toLowerCase();
    for (let [key, value] of BOOK_INDEX_MAP) {
        if (key.toLowerCase() === lowerNormalized) {
            return value;
        }
    }
    
    return null;
}

// Выделение библейских ссылок
function highlightBibleRefs(htmlEscaped) {
    const bibleRefRegex = /\(?(?:(?:[1-3]\s)?[А-ЯІЄҐ][а-яіїєґ']+(?:\s[А-ЯІЄҐ][а-яіїєґ']+)*\.?\s*\d+(?::\d+(?:-\d+)?|-\d+)?(?:\s*,\s*(?:[1-3]\s)?[А-ЯІЄҐ][а-яіїєґ']+(?:\s[А-ЯІЄҐ][а-яіїєґ']+)*\.?\s*\d+(?::\d+(?:-\d+)?|-\d+)?)*)\)?/g;
    
    return htmlEscaped.replace(bibleRefRegex, (match) => {
        if (match.includes('<span class="bible-ref">')) {
            return match;
        }
        
        if (match.includes(',')) {
            const content = match.replace(/[()]/g, '');
            const refs = content.split(',').map(ref => ref.trim());
            const highlightedRefs = refs.map(ref => `<span class="bible-ref">${ref}</span>`).join(', ');
            return match.startsWith('(') ? `(${highlightedRefs})` : highlightedRefs;
        } else {
            const cleanRef = match.replace(/[()]/g, '');
            return match.startsWith('(') && match.endsWith(')') 
                ? `(<span class="bible-ref">${cleanRef}</span>)`
                : `<span class="bible-ref">${match}</span>`;
        }
    });
}

function formatAssistantMessage(raw) {
    let out = escapeHTML(raw);
    out = linkify(out);
    out = highlightBibleRefs(out);
    return out.replace(/\n/g, "<br>");
}

// Управление данными
function saveData() {
    const data = {
        ...appData,
        lastSaved: Date.now(),
        version: "1.0"
    };
    try {
        const jsonStr = JSON.stringify(data);
        localStorage.setItem('bibleAssistantData', jsonStr);
        console.log('Данные сохранены:', Object.keys(data.sessions).length, 'сессий,', Object.keys(data.notes).length, 'заметок');
    } catch (e) {
        console.error('Ошибка сохранения данных:', e);
        alert('Помилка збереження даних: ' + e.message);
    }
}

function loadData() {
    try {
        const stored = localStorage.getItem('bibleAssistantData');
        if (stored) {
            const data = JSON.parse(stored);
            appData = {
                sessions: data.sessions || {},
                notes: data.notes || {},
                currentSessionId: data.currentSessionId || null,
                messageCounter: data.messageCounter || 0
            };
            console.log('Данные загружены:', Object.keys(appData.sessions).length, 'сессий,', Object.keys(appData.notes).length, 'заметок');
            return true;
        }
    } catch (e) {
        console.error('Ошибка загрузки данных:', e);
        alert('Помилка завантаження даних: ' + e.message);
    }
    return false;
}

// Управление сессиями
function createSession(title = null) {
    const sessionId = generateId();
    const sessionTitle = title || `Сесія ${Object.keys(appData.sessions).length + 1}`;
    
    appData.sessions[sessionId] = {
        id: sessionId,
        title: sessionTitle,
        messages: [{ role: "system", content: DEFAULT_PROMPT }],
        created: Date.now(),
        updated: Date.now()
    };
    
    appData.currentSessionId = sessionId;
    saveData();
    renderSessions();
    loadSession(sessionId);
    
    return sessionId;
}

function loadSession(sessionId) {
    if (!appData.sessions[sessionId]) {
        console.error('Сессия не найдена:', sessionId);
        return;
    }

    appData.currentSessionId = sessionId;
    const session = appData.sessions[sessionId];
    
    // Обновляем заголовок
    document.getElementById('chatTitle').textContent = session.title;
    
    // Очищаем чат
    const chatArea = document.getElementById('chatArea');
    chatArea.innerHTML = '';
    
    // Отображаем сообщения (кроме системного)
    const userMessages = session.messages.filter(msg => msg.role !== 'system');
    userMessages.forEach((msg, index) => {
        const messageId = msg.id || `msg_${index}`;
        appendMessage(msg.role, msg.content, messageId, msg.role === 'assistant');
    });
    
    // Если нет сообщений, показываем приветствие
    if (userMessages.length === 0) {
        showWelcomeMessage();
    }
    
    renderSessions();
    saveData();
}

function showWelcomeMessage() {
    const chatArea = document.getElementById('chatArea');
    const welcomeDiv = document.createElement('div');
    welcomeDiv.className = 'message ai';
    welcomeDiv.innerHTML = `
        <span class="message-role">AI:</span>
        <span class="message-text">
            <span style="color: var(--muted);">🙏 Вітаю! Я - ваш AI асистент для вивчення Біблії. Задавайте будь-які питання про Святе Письмо!</span>
        </span>
    `;
    chatArea.appendChild(welcomeDiv);
}

function deleteSession(sessionId) {
    if (!confirm('Ви дійсно хочете видалити цю сесію?')) return;
    
    delete appData.sessions[sessionId];
    
    // Удаляем связанные заметки
    Object.keys(appData.notes).forEach(noteId => {
        if (appData.notes[noteId].sessionId === sessionId) {
            delete appData.notes[noteId];
        }
    });
    
    // Если удаляем текущую сессию
    if (appData.currentSessionId === sessionId) {
        const sessionIds = Object.keys(appData.sessions);
        if (sessionIds.length > 0) {
            loadSession(sessionIds[sessionIds.length - 1]);
        } else {
            appData.currentSessionId = null;
            document.getElementById('chatArea').innerHTML = `
                <div class="empty-state">
                    <h3>Вітаємо у Біблійному Асистенті!</h3>
                    <p>Створіть нову сесію для початку роботи.</p>
                </div>
            `;
            document.getElementById('chatTitle').textContent = 'Біблійний чат';
        }
    }
    
    saveData();
    renderSessions();
    renderNotes();
}

// Управление заметками
function createNote(data) {
    const noteId = generateId();
    appData.notes[noteId] = {
        id: noteId,
        title: data.title,
        type: data.type || 'note', // 'note' or 'bookmark'
        category: data.category || '',
        reference: data.reference || '',
        content: data.content || '',
        sessionId: data.sessionId || appData.currentSessionId,
        messageId: data.messageId || null,
        created: Date.now(),
        updated: Date.now()
    };
    
    saveData();
    renderNotes();
    return noteId;
}

function deleteNote(noteId) {
    if (!confirm('Ви дійсно хочете видалити цю нотатку?')) return;
    
    delete appData.notes[noteId];
    saveData();
    renderNotes();
}

function goToNoteMessage(noteId) {
    const note = appData.notes[noteId];
    if (!note || !note.sessionId || !note.messageId) return;
    
    // Загружаем сессию если нужно
    if (appData.currentSessionId !== note.sessionId) {
        loadSession(note.sessionId);
    }
    
    // Ищем сообщение и скроллим к нему
    setTimeout(() => {
        const messageElement = document.querySelector(`[data-message-id="${note.messageId}"]`);
        if (messageElement) {
            messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            messageElement.style.background = 'rgba(255, 204, 0, 0.2)';
            setTimeout(() => {
                messageElement.style.background = '';
            }, 2000);
        }
    }, 100);
    
    // Переключаемся на вкладку сессий и сворачиваем сайдбар на мобильных
    switchTab('sessions');
    if (window.innerWidth <= 768) {
        closeSidebar();
    }
}

// Отображение списков
function renderSessions() {
    const container = document.getElementById('sessions-list');
    const emptyState = document.getElementById('sessions-empty');
    const sessions = Object.values(appData.sessions).sort((a, b) => b.updated - a.updated);
    
    if (sessions.length === 0) {
        container.innerHTML = '';
        emptyState.style.display = 'block';
        return;
    }
    
    emptyState.style.display = 'none';
    container.innerHTML = sessions.map(session => {
        const isActive = session.id === appData.currentSessionId;
        const messageCount = session.messages.filter(m => m.role !== 'system').length;
        
        return `
            <div class="list-item ${isActive ? 'selected' : ''}" onclick="loadSession('${session.id}')">
                <div class="item-actions">
                    <button class="action-btn edit" onclick="editSession('${session.id}', event)" title="Редагувати">✏️</button>
                    <button class="action-btn delete" onclick="deleteSession('${session.id}')" title="Видалити">🗑️</button>
                </div>
                <div class="item-title">${escapeHTML(session.title)}</div>
                <div class="item-meta">
                    <span>${messageCount} повідомлень</span>
                    <span>${formatDate(session.updated)}</span>
                </div>
            </div>
        `;
    }).join('');
}

function renderNotes() {
    const container = document.getElementById('notes-list');
    const emptyState = document.getElementById('notes-empty');
    const notes = Object.values(appData.notes).sort((a, b) => b.updated - a.updated);
    
    if (notes.length === 0) {
        container.innerHTML = '';
        emptyState.style.display = 'block';
        return;
    }
    
    emptyState.style.display = 'none';
    container.innerHTML = notes.map(note => {
        const isBookmark = note.type === 'bookmark';
        const categoryClass = note.category ? `category-${note.category}` : '';
        
        return `
            <div class="list-item" onclick="goToNoteMessage('${note.id}')">
                <div class="item-actions">
                    <button class="action-btn edit" onclick="editNote('${note.id}', event)" title="Редагувати">✏️</button>
                    <button class="action-btn delete" onclick="deleteNote('${note.id}')" title="Видалити">🗑️</button>
                </div>
                <div class="item-title">
                    ${isBookmark ? '🔖' : '📖'} ${escapeHTML(note.title)}
                </div>
                <div class="item-meta">
                    ${note.category ? `<span class="item-category ${categoryClass}">${getCategoryName(note.category)}</span>` : ''}
                    <span>${formatDate(note.updated)}</span>
                </div>
                ${note.reference ? `<div style="font-size: 11px; color: var(--muted); margin-top: 4px;">${escapeHTML(note.reference)}</div>` : ''}
            </div>
        `;
    }).join('');
}

function getCategoryName(category) {
    const categories = {
        'study': '📖 Вивчення',
        'prayer': '🙏 Молитва',
        'sermon': '🎤 Проповідь',
        'personal': '💭 Особисте'
    };
    return categories[category] || category;
}

// Поиск
function performContextSearch(query) {
    const searchResults = document.getElementById('searchResults');
    
    if (!query.trim()) {
        searchResults.classList.remove('active');
        return;
    }
    
    const results = [];
    const searchTerm = query.toLowerCase();
    
    // Поиск в сессиях
    Object.values(appData.sessions).forEach(session => {
        let relevanceScore = 0;
        let matchedContent = '';
        
        // Проверяем заголовок
        if (session.title.toLowerCase().includes(searchTerm)) {
            relevanceScore += 10;
            matchedContent = session.title;
        }
        
        // Проверяем сообщения в сессии
        if (session.messages) {
            session.messages.forEach((msg, index) => {
                if (msg.role !== 'system' && msg.content.toLowerCase().includes(searchTerm)) {
                    relevanceScore += 5;
                    if (!matchedContent) {
                        matchedContent = msg.content.substring(0, 100) + '...';
                    }
                }
            });
        }
        
        if (relevanceScore > 0) {
            results.push({
                type: 'session',
                id: session.id,
                title: session.title,
                preview: matchedContent || `${session.messages.filter(m => m.role !== 'system').length} повідомлень`,
                meta: formatDate(session.updated),
                relevance: relevanceScore
            });
        }
    });
    
    // Поиск в заметках
    Object.values(appData.notes).forEach(note => {
        let relevanceScore = 0;
        let matchedContent = '';
        
        // Проверяем заголовок
        if (note.title.toLowerCase().includes(searchTerm)) {
            relevanceScore += 10;
            matchedContent = note.title;
        }
        
        // Проверяем содержимое
        if (note.content && note.content.toLowerCase().includes(searchTerm)) {
            relevanceScore += 8;
            if (!matchedContent) {
                matchedContent = note.content.substring(0, 100) + '...';
            }
        }
        
        // Проверяем библейские ссылки
        if (note.reference && note.reference.toLowerCase().includes(searchTerm)) {
            relevanceScore += 6;
            if (!matchedContent) {
                matchedContent = note.reference;
            }
        }
        
        if (relevanceScore > 0) {
            results.push({
                type: 'note',
                id: note.id,
                title: note.title,
                preview: matchedContent || (note.type === 'bookmark' ? '🔖 Закладка' : '📖 Нотатка'),
                meta: note.category ? getCategoryName(note.category) : '🔖 Закладка',
                relevance: relevanceScore
            });
        }
    });
    
    // Сортируем по релевантности
    results.sort((a, b) => b.relevance - a.relevance);
    
    renderSearchResults(results, searchTerm);
}

function renderSearchResults(results, searchTerm) {
    const container = document.getElementById('searchResults');
    
    if (results.length === 0) {
        container.innerHTML = `
            <div class="search-result">
                <div class="result-preview" style="text-align: center; color: var(--muted);">
                    Нічого не знайдено для "${searchTerm}"
                </div>
            </div>
        `;
    } else {
        container.innerHTML = results.map(result => {
            const typeIcon = result.type === 'session' ? '📝' : (result.type === 'note' ? '📖' : '🔖');
            const typeName = result.type === 'session' ? 'сесія' : 'нотатка';
            
            return `
                <div class="search-result" onclick="selectSearchResult('${result.type}', '${result.id}')">
                    <div class="result-type">${typeIcon} ${typeName}</div>
                    <div class="result-title">${highlightSearchText(escapeHTML(result.title), searchTerm)}</div>
                    <div class="result-preview">${highlightSearchText(escapeHTML(result.preview), searchTerm)}</div>
                    <div class="result-meta">
                        <span>${result.meta}</span>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    container.classList.add('active');
}

function selectSearchResult(type, id) {
    // Закрываем результаты поиска
    const searchResults = document.getElementById('searchResults');
    searchResults.classList.remove('active');
    document.getElementById('contextSearch').value = '';
    
    if (type === 'session') {
        // Загружаем сессию
        loadSession(id);
        switchTab('sessions');
        
        // Закрываем сайдбар на мобильных устройствах
        if (window.innerWidth <= 768) {
            closeSidebar();
        }
    } else if (type === 'note') {
        // Переходим к заметке
        goToNoteMessage(id);
    }
}

function searchSessions(query) {
    const container = document.getElementById('sessions-list');
    const sessions = Object.values(appData.sessions);
    
    const filtered = sessions.filter(session => {
        return session.title.toLowerCase().includes(query) ||
               session.messages.some(msg => msg.content && msg.content.toLowerCase().includes(query));
    }).sort((a, b) => b.updated - a.updated);
    
    if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state"><h3>Нічого не знайдено</h3><p>Спробуйте інший запит</p></div>';
        return;
    }
    
    container.innerHTML = filtered.map(session => {
        const isActive = session.id === appData.currentSessionId;
        const messageCount = session.messages ? session.messages.filter(m => m.role !== 'system').length : 0;
        
        return `
            <div class="list-item ${isActive ? 'selected' : ''}" onclick="loadSession('${session.id}')">
                <div class="item-actions">
                    <button class="action-btn edit" onclick="editSession('${session.id}', event)" title="Редагувати">✏️</button>
                    <button class="action-btn delete" onclick="deleteSession('${session.id}')" title="Видалити">🗑️</button>
                </div>
                <div class="item-title">${highlightSearchText(escapeHTML(session.title), query)}</div>
                <div class="item-meta">
                    <span>${messageCount} повідомлень</span>
                    <span>${formatDate(session.updated)}</span>
                </div>
            </div>
        `;
    }).join('');
}

function searchNotes(query) {
    const container = document.getElementById('notes-list');
    const notes = Object.values(appData.notes);
    
    const filtered = notes.filter(note => {
        return note.title.toLowerCase().includes(query) ||
               (note.content && note.content.toLowerCase().includes(query)) ||
               (note.reference && note.reference.toLowerCase().includes(query));
    }).sort((a, b) => b.updated - a.updated);
    
    if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state"><h3>Нічого не знайдено</h3><p>Спробуйте інший запит</p></div>';
        return;
    }
    
    container.innerHTML = filtered.map(note => {
        const isBookmark = note.type === 'bookmark';
        const categoryClass = note.category ? `category-${note.category}` : '';
        
        return `
            <div class="list-item" onclick="goToNoteMessage('${note.id}')">
                <div class="item-actions">
                    <button class="action-btn edit" onclick="editNote('${note.id}', event)" title="Редагувати">✏️</button>
                    <button class="action-btn delete" onclick="deleteNote('${note.id}')" title="Видалити">🗑️</button>
                </div>
                <div class="item-title">
                    ${isBookmark ? '🔖' : '📖'} ${highlightSearchText(escapeHTML(note.title), query)}
                </div>
                <div class="item-meta">
                    ${note.category ? `<span class="item-category ${categoryClass}">${getCategoryName(note.category)}</span>` : ''}
                    <span>${formatDate(note.updated)}</span>
                </div>
                ${note.reference ? `<div style="font-size: 11px; color: var(--muted); margin-top: 4px;">${highlightSearchText(escapeHTML(note.reference), query)}</div>` : ''}
            </div>
        `;
    }).join('');
}

function highlightSearchText(text, query) {
    const regex = new RegExp(`(${query})`, 'gi');
    return text.replace(regex, '<mark>$1</mark>');
}

// Отображение сообщений
function appendMessage(role, content, messageId = null, showMarker = false) {
    const chatArea = document.getElementById('chatArea');
    
    // Удаляем приветственное сообщение если есть
    const emptyState = chatArea.querySelector('.empty-state');
    if (emptyState) {
        emptyState.remove();
    }
    
    const messageElement = document.createElement('div');
    messageElement.className = `message ${role === 'assistant' ? 'ai' : 'user'}`;
    if (messageId) {
        messageElement.setAttribute('data-message-id', messageId);
    }
    
    const formattedContent = role === 'assistant' ? formatAssistantMessage(content) : escapeHTML(content);
    
    messageElement.innerHTML = `
        <span class="message-role">${role === 'assistant' ? 'AI' : 'Ви'}:</span>
        <span class="message-text">${formattedContent}</span>
        ${showMarker ? `<button class="message-marker" onclick="showMessageNoteModal('${messageId}')" title="Створити нотатку">📝</button>` : ''}
    `;
    
    chatArea.appendChild(messageElement);
    chatArea.scrollTop = chatArea.scrollHeight;
    
    // Прикрепляем обработчики для библейских ссылок
    if (role === 'assistant') {
        setTimeout(() => attachBibleRefHandlers(), 10);
    }
}

// API для работы с чатом
async function loadModels() {
    const modelSelect = document.getElementById('model');
    modelSelect.innerHTML = "";
    
    try {
        const res = await fetch(MODELS_URL, { 
            headers: { "Authorization": `Bearer ${apiKey}` }
        });
        
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        
        const data = await res.json();
        const models = data?.data || [];

        models.forEach(m => {
            const option = document.createElement('option');
            option.value = m.id;
            option.textContent = m.id;
            modelSelect.appendChild(option);
        });

        // Устанавливаем модель по умолчанию
        const defaultModel = "meta-llama/llama-4-maverick-17b-128e-instruct";
        if ([...modelSelect.options].some(o => o.value === defaultModel)) {
            modelSelect.value = defaultModel;
        } else if (modelSelect.options.length > 0) {
            modelSelect.selectedIndex = 0;
        }

    } catch (e) {
        modelSelect.innerHTML = `<option value="">Помилка завантаження моделей</option>`;
        console.error("Ошибка загрузки моделей:", e);
    }
}

async function sendMessage() {
    if (isLoading) return;
    
    const input = document.getElementById('userInput');
    const modelSelect = document.getElementById('model');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Создаем сессию если нужно
    if (!appData.currentSessionId) {
        createSession();
    }
    
    const session = appData.sessions[appData.currentSessionId];
    if (!session) return;
    
    // Генерируем ID для сообщений
    const userMessageId = generateId();
    const aiMessageId = generateId();
    
    // Добавляем сообщение пользователя
    const userMessage = { role: "user", content: message, id: userMessageId };
    session.messages.push(userMessage);
    appendMessage("user", message, userMessageId);
    
    input.value = "";
    isLoading = true;
    document.getElementById('sendBtn').disabled = true;
    
    try {
        // Подготавливаем сообщения для API (без поля id)
        const messagesForAPI = session.messages.map(msg => ({
            role: msg.role,
            content: msg.content
        }));
        
        const res = await fetch(API_URL, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: modelSelect.value || "meta-llama/llama-4-maverick-17b-128e-instruct",
                messages: messagesForAPI,
                temperature: 0.7,
                max_tokens: 1500
            })
        });

        if (!res.ok) {
            const errorText = await res.text().catch(() => "");
            throw new Error(`HTTP ${res.status}: ${errorText || res.statusText}`);
        }

        const data = await res.json();
        const reply = data?.choices?.[0]?.message?.content || "Немає відповіді.";
        
        // Добавляем ответ AI
        const aiMessage = { role: "assistant", content: reply, id: aiMessageId };
        session.messages.push(aiMessage);
        appendMessage("assistant", reply, aiMessageId, true);
        
        // Обновляем сессию
        session.updated = Date.now();
        saveData();
        renderSessions();
        
        // Скрываем панель управления после первого сообщения
        hideChatControlsAfterFirstMessage();

    } catch (err) {
        appendMessage("assistant", `<span style="color: var(--muted);">Помилка: ${escapeHTML(err.message)}</span>`, null, false);
        console.error('Ошибка отправки сообщения:', err);
    } finally {
        isLoading = false;
        document.getElementById('sendBtn').disabled = false;
        document.getElementById('userInput').focus();
    }
}

// Обработка библейских ссылок
function showVerseModal(title, content, bookNum, chapter) {
    const modal = document.getElementById("verseModal");
    modal.style.display = "flex";
    
    const isChapterRange = title.includes('-') && !title.includes(':');
    
    modal.innerHTML = `
        <div class="modal-content">
            <h2>📖 ${title}</h2>
            <div style="line-height: 1.6; font-size: 16px; margin: 16px 0;">${content}</div>
            <div class="form-actions">
                ${!isChapterRange ? `<button class="btn btn-secondary" id="show-chapter">Показати всю главу</button>` : ''}
                <button class="btn btn-primary" id="close-verse-modal">Закрити</button>
            </div>
        </div>`;
    
    modal.querySelector("#close-verse-modal").addEventListener("click", () => {
        modal.style.display = "none";
    });
    
    const showChapterBtn = modal.querySelector("#show-chapter");
    if (showChapterBtn) {
        showChapterBtn.addEventListener("click", async () => {
            const button = showChapterBtn;
            const originalText = button.textContent;
            button.innerHTML = 'Завантаження... <span style="display: inline-block; width: 16px; height: 16px; border: 2px solid var(--border); border-radius: 50%; border-top-color: var(--primary); animation: spin 1s ease-in-out infinite;"></span>';
            button.disabled = true;
            
            try {
                const chapterText = await window.bible.getChapterText(bookNum, chapter);
                const formatted = chapterText
                    .replace(/\s*(\d+\.)/g, "<br><b>$1</b>")
                    .replace(/^<br>/, "");
                modal.querySelector(".modal-content div[style*='line-height']").innerHTML = formatted;
                modal.querySelector("h2").textContent = `📖 ${title.split(':')[0]} - вся глава ${chapter}`;
                button.style.display = 'none';
            } catch (error) {
                button.textContent = 'Помилка завантаження';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.disabled = false;
                }, 2000);
            }
        });
    }
    
    modal.addEventListener("click", (e) => {
        if (e.target.id === "verseModal") {
            modal.style.display = "none";
        }
    });
}

function attachBibleRefHandlers() {
    document.querySelectorAll(".bible-ref").forEach(el => {
        if (el.dataset.bound) return;
        el.dataset.bound = "1";
        
        el.addEventListener("click", async (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            const refText = el.innerText.trim();
            
            const verseMatch = refText.match(/(.+?)\s*(\d+):([\d,\-\s]+)/);
            const chapterRangeMatch = !verseMatch && refText.match(/(.+?)\s*(\d+)-(\d+)$/);
            const singleChapterMatch = !verseMatch && !chapterRangeMatch && refText.match(/(.+?)\s*(\d+)$/);
            
            if (verseMatch) {
                const [, bookNameRaw, chapter, verseStr] = verseMatch;
                const bookName = bookNameRaw.trim().replace(/\.$/, '');
                const bookNum = getBookNumber(bookName);
                
                if (!bookNum) { 
                    alert("Невідома книга: " + bookName); 
                    return; 
                }

                el.style.opacity = '0.6';
                el.style.cursor = 'wait';

                try {
                    let verses = [];
                    
                    if (verseStr.includes(",") || verseStr.includes("-")) {
                        verses = await window.bible.getVersesRange(bookNum, chapter, verseStr);
                    } else {
                        const v = await window.bible.getVerse(bookNum, chapter, verseStr);
                        if (v) verses = [v];
                    }

                    if (verses.length) {
                        const html = verses.map(v => `<b>${v.number}.</b> ${v.text}`).join("<br>");
                        showVerseModal(`${bookName} ${chapter}:${verseStr}`, html, bookNum, chapter);
                    } else {
                        alert("Стих(и) не знайдено");
                    }
                } catch (error) {
                    console.error("Error loading bible verse:", error);
                    alert("Помилка завантаження тексту Біблії");
                } finally {
                    el.style.opacity = '1';
                    el.style.cursor = 'pointer';
                }
                
            } else if (chapterRangeMatch) {
                const [, bookNameRaw, startChapter, endChapter] = chapterRangeMatch;
                const bookName = bookNameRaw.trim().replace(/\.$/, '');
                const bookNum = getBookNumber(bookName);
                
                if (!bookNum) { 
                    alert("Невідома книга: " + bookName); 
                    return; 
                }

                el.style.opacity = '0.6';
                el.style.cursor = 'wait';

                try {
                    let allChaptersText = '';
                    const start = parseInt(startChapter);
                    const end = parseInt(endChapter);
                    
                    for (let chapter = start; chapter <= end; chapter++) {
                        const chapterText = await window.bible.getChapterText(bookNum, chapter);
                        const formatted = chapterText
                            .replace(/\s*(\d+\.)/g, "<br><b>$1</b>")
                            .replace(/^<br>/, "");
                        allChaptersText += `<h3>Глава ${chapter}</h3>${formatted}<br><br>`;
                    }
                    
                    showVerseModal(`${bookName} ${startChapter}-${endChapter}`, allChaptersText, bookNum, start);
                } catch (error) {
                    console.error("Error loading bible chapters:", error);
                    alert("Помилка завантаження тексту Біблії");
                } finally {
                    el.style.opacity = '1';
                    el.style.cursor = 'pointer';
                }
                
            } else if (singleChapterMatch) {
                const [, bookNameRaw, chapter] = singleChapterMatch;
                const bookName = bookNameRaw.trim().replace(/\.$/, '');
                const bookNum = getBookNumber(bookName);
                
                if (!bookNum) { 
                    alert("Невідома книга: " + bookName); 
                    return; 
                }

                el.style.opacity = '0.6';
                el.style.cursor = 'wait';

                try {
                    const chapterText = await window.bible.getChapterText(bookNum, chapter);
                    const formatted = chapterText
                        .replace(/\s*(\d+\.)/g, "<br><b>$1</b>")
                        .replace(/^<br>/, "");
                    showVerseModal(`${bookName} ${chapter}`, formatted, bookNum, chapter);
                } catch (error) {
                    console.error("Error loading bible chapter:", error);
                    alert("Помилка завантаження тексту Біблії");
                } finally {
                    el.style.opacity = '1';
                    el.style.cursor = 'pointer';
                }
                
            } else {
                console.log("Unrecognized format:", refText);
                alert("Не вдалося розпізнати формат посилання: " + refText);
            }
        });
    });
}

// UI функции
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    const overlay = document.getElementById('overlay');
    
    if (window.innerWidth <= 768) {
        // Мобильная версия
        if (sidebar.classList.contains('open')) {
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
        } else {
            sidebar.classList.add('open');
            overlay.classList.add('active');
        }
    } else {
        // Десктопная версия
        if (sidebar.classList.contains('collapsed')) {
            sidebar.classList.remove('collapsed');
            mainContent.classList.remove('sidebar-collapsed');
        } else {
            sidebar.classList.add('collapsed');
            mainContent.classList.add('sidebar-collapsed');
        }
    }
}

function closeSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    
    sidebar.classList.remove('open');
    overlay.classList.remove('active');
}

function switchTab(tabName) {
    activeTab = tabName;
    
    // Обновляем табы
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    
    // Обновляем панели
    document.querySelectorAll('.panel').forEach(panel => {
        panel.classList.remove('active');
    });
    document.getElementById(`${tabName}-panel`).classList.add('active');
    
    // Очищаем поиск и перерендериваем
    document.getElementById('contextSearch').value = '';
    if (tabName === 'sessions') {
        renderSessions();
    } else {
        renderNotes();
    }
}

function toggleChatControls() {
    const controls = document.getElementById('chatControls');
    const toggleBtn = document.querySelector('.controls-toggle-btn');
    
    chatControlsVisible = !chatControlsVisible;
    
    if (chatControlsVisible) {
        controls.classList.remove('hidden');
        toggleBtn.textContent = '⚙️';
        toggleBtn.title = 'Сховати налаштування';
    } else {
        controls.classList.add('hidden');
        toggleBtn.textContent = '🔧';
        toggleBtn.title = 'Показати налаштування';
    }
}

function hideChatControlsAfterFirstMessage() {
    if (chatControlsVisible && appData.currentSessionId) {
        const session = appData.sessions[appData.currentSessionId];
        const messageCount = session.messages.filter(m => m.role !== 'system').length;
        if (messageCount === 2) { // первое сообщение пользователя + первый ответ AI
            setTimeout(() => {
                toggleChatControls();
            }, 1000);
        }
    }
}

// Темы
function toggleTheme() {
    const currentTheme = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    applyTheme(currentTheme);
    localStorage.setItem('theme', currentTheme);
}

function applyTheme(theme) {
    const themeBtn = document.getElementById('themeBtn');
    if (theme === 'dark') {
        document.body.setAttribute('data-theme', 'dark');
        themeBtn.textContent = '☀️ Тема';
    } else {
        document.body.removeAttribute('data-theme');
        themeBtn.textContent = '🌙 Тема';
    }
}

// Модальные окна
function createNew() {
    document.getElementById('createModal').classList.add('active');
    document.getElementById('createTitle').focus();
}

function showMessageNoteModal(messageId) {
    currentMessageForNote = messageId;
    document.getElementById('messageNoteModal').classList.add('active');
    document.getElementById('messageNoteTitle').focus();
}

function showOptions() {
    document.getElementById('optionsModal').classList.add('active');
}

function showHelp() {
    document.getElementById('helpModal').classList.add('active');
}

function closeModal() {
    document.querySelectorAll('.modal').forEach(modal => {
        modal.classList.remove('active');
    });
    currentMessageForNote = null;
}

function toggleCreateFields() {
    const type = document.getElementById('createType').value;
    const fields = document.getElementById('noteFields');
    
    if (type === 'note') {
        fields.style.display = 'block';
    } else {
        fields.style.display = 'none';
    }
}

function toggleMessageNoteFields() {
    const type = document.getElementById('messageNoteType').value;
    const fields = document.getElementById('messageNoteFields');
    
    if (type === 'note') {
        fields.style.display = 'block';
    } else {
        fields.style.display = 'none';
    }
}

function createItem() {
    const type = document.getElementById('createType').value;
    const title = document.getElementById('createTitle').value.trim();
    
    if (!title) {
        alert('Введіть назву');
        return;
    }
    
    if (type === 'session') {
        createSession(title);
    } else {
        const data = {
            title: title,
            type: type === 'bookmark' ? 'bookmark' : 'note'
        };
        
        if (type === 'note') {
            data.category = document.getElementById('createCategory').value;
            data.reference = document.getElementById('createReference').value.trim();
            data.content = document.getElementById('createContent').value.trim();
        }
        
        createNote(data);
    }
    
    closeModal();
    
    // Очищаем форму
    document.getElementById('createTitle').value = '';
    document.getElementById('createReference').value = '';
    document.getElementById('createContent').value = '';
}

function createMessageNote() {
    const title = document.getElementById('messageNoteTitle').value.trim();
    const type = document.getElementById('messageNoteType').value;
    
    if (!title) {
        alert('Введіть назву');
        return;
    }
    
    const data = {
        title: title,
        type: type === 'bookmark' ? 'bookmark' : 'note',
        messageId: currentMessageForNote,
        sessionId: appData.currentSessionId
    };
    
    if (type === 'note') {
        data.category = document.getElementById('messageNoteCategory').value;
        data.reference = document.getElementById('messageNoteReference').value.trim();
        data.content = document.getElementById('messageNoteContent').value.trim();
    }
    
    createNote(data);
    closeModal();
    
    // Очищаем форму
    document.getElementById('messageNoteTitle').value = '';
    document.getElementById('messageNoteReference').value = '';
    document.getElementById('messageNoteContent').value = '';
    
    // Переключаемся на вкладку заметок
    switchTab('notes');
}

// Импорт/экспорт
function exportData() {
    try {
        const data = {
            ...appData,
            exportDate: Date.now(),
            version: "1.0"
        };
        
        const jsonStr = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `bible-assistant-backup-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        closeModal();
        alert('Дані експортовано успішно!');
    } catch (e) {
        alert('Помилка експорту: ' + e.message);
    }
}

function importData() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                
                if (!data.sessions || !data.notes) {
                    throw new Error('Невірний формат файлу');
                }
                
                if (confirm('Це замінить всі поточні дані. Продовжити?')) {
                    appData = {
                        sessions: data.sessions || {},
                        notes: data.notes || {},
                        currentSessionId: data.currentSessionId || null,
                        messageCounter: data.messageCounter || 0
                    };
                    
                    saveData();
                    renderSessions();
                    renderNotes();
                    
                    // Загружаем последнюю сессию
                    const sessionIds = Object.keys(appData.sessions);
                    if (sessionIds.length > 0 && appData.currentSessionId) {
                        loadSession(appData.currentSessionId);
                    } else if (sessionIds.length > 0) {
                        const lastSession = Object.values(appData.sessions)
                            .sort((a, b) => b.updated - a.updated)[0];
                        loadSession(lastSession.id);
                    }
                    
                    closeModal();
                    alert('Дані імпортовано успішно!');
                }
            } catch (e) {
                alert('Помилка імпорту: ' + e.message);
            }
        };
        reader.readAsText(file);
    };
    
    input.click();
}

function clearAll() {
    if (confirm('⚠️ УВАГА!\n\nВи дійсно хочете видалити ВСІ дані?\n\n• Всі сесії будуть втрачені\n• Всі нотатки будуть видалені\n• Цю дію неможливо відмінити\n\nНатисніть OK для підтвердження або Скасувати для відміни.')) {
        appData = {
            sessions: {},
            notes: {},
            currentSessionId: null,
            messageCounter: 0
        };
        
        saveData();
        renderSessions();
        renderNotes();
        
        document.getElementById('chatArea').innerHTML = `
            <div class="empty-state">
                <h3>Вітаємо у Біблійному Асистенті!</h3>
                <p>Створіть нову сесію для початку роботи.</p>
            </div>
        `;
        document.getElementById('chatTitle').textContent = 'Біблійний чат';
        
        closeModal();
        alert('✅ Всі дані успішно очищено!');
    }
}

// Обработчики событий
function handleInputKeypress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

function editSession(sessionId, event) {
    event.stopPropagation();
    const session = appData.sessions[sessionId];
    if (!session) return;
    
    const newTitle = prompt('Нова назва сесії:', session.title);
    if (newTitle && newTitle.trim() !== session.title) {
        session.title = newTitle.trim();
        session.updated = Date.now();
        saveData();
        renderSessions();
        
        if (sessionId === appData.currentSessionId) {
            document.getElementById('chatTitle').textContent = session.title;
        }
    }
}

function editNote(noteId, event) {
    event.stopPropagation();
    const note = appData.notes[noteId];
    if (!note) return;
    
    const newTitle = prompt('Нова назва нотатки:', note.title);
    if (newTitle && newTitle.trim() !== note.title) {
        note.title = newTitle.trim();
        note.updated = Date.now();
        saveData();
        renderNotes();
    }
}

// Инициализация
document.addEventListener('DOMContentLoaded', async () => {
    console.log('Инициализация Библейского Асистента...');
    
    // Загружаем сохраненные данные
    loadData();
    
    // Применяем сохраненную тему
    const savedTheme = localStorage.getItem('theme') || 'light';
    applyTheme(savedTheme);
    
    // Загружаем модели AI
    await loadModels();
    
    // Рендерим списки
    renderSessions();
    renderNotes();
    
    // Загружаем последнюю сессию или показываем пустое состояние
    if (appData.currentSessionId && appData.sessions[appData.currentSessionId]) {
        loadSession(appData.currentSessionId);
    } else {
        const sessionIds = Object.keys(appData.sessions);
        if (sessionIds.length > 0) {
            const lastSession = Object.values(appData.sessions)
                .sort((a, b) => b.updated - a.updated)[0];
            loadSession(lastSession.id);
        } else {
            // Показываем приветственное сообщение
            document.getElementById('chatArea').innerHTML = `
                <div class="empty-state">
                    <h3>Вітаємо у Біблійному Асистенті!</h3>
                    <p>Створіть нову сесію для початку роботи.</p>
                </div>
            `;
        }
    }
    
    // Фокус на поле ввода
    document.getElementById('userInput').focus();
    
    // Обработчики закрытия модальных окон по клику вне них
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });
    });
    
    // Обработчик для закрытия поиска при клике вне его
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.search-container')) {
            document.getElementById('searchResults').classList.remove('active');
        }
    });
    
    // Обработчик клавиши Escape
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeModal();
            
            // Закрываем результаты поиска
            const searchResults = document.getElementById('searchResults');
            if (searchResults.classList.contains('active')) {
                searchResults.classList.remove('active');
                document.getElementById('contextSearch').value = '';
                document.getElementById('contextSearch').blur();
            }
            
            // Закрываем модальные окна с библейскими стихами
            const verseModal = document.getElementById('verseModal');
            if (verseModal.style.display === 'flex') {
                verseModal.style.display = 'none';
            }
        }
        
        // Горячие клавиши для поиска (Ctrl+K или Cmd+K)
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            document.getElementById('contextSearch').focus();
        }
        
        // Горячая клавиша для создания новой сессии (Ctrl+N или Cmd+N)
        if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
            e.preventDefault();
            createNew();
        }
    });
    
    // Ждем загрузки Bible API
    if (typeof window.bible === 'undefined') {
        console.log('Ожидание загрузки Bible API...');
        const checkBibleAPI = setInterval(() => {
            if (typeof window.bible !== 'undefined') {
                console.log('Bible API загружен успешно!');
                clearInterval(checkBibleAPI);
            }
        }, 500);
    } else {
        console.log('Bible API уже доступен!');
    }
    
    console.log('Библейский Асистент готов к работе!');
    console.log('Загружено:', Object.keys(appData.sessions).length, 'сессий и', Object.keys(appData.notes).length, 'заметок');
});

</script>

</body>
</html>